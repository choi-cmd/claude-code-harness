{% extends "base.html" %}
{% block pwa %}
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ì•„í¬ë¦´ ì£¼ë¬¸ê´€ë¦¬">
    <link rel="apple-touch-icon" href="/static/images/icon-192.png">
    <link rel="manifest" href="/static/manifest-admin.json">
{% endblock %}
{% block pwa_script %}{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header">
        <h1>ğŸ“¦ ì•„í¬ë¦´ ì£¼ë¬¸ê´€ë¦¬</h1>
        <div class="admin-actions">
            <a href="/" class="btn-action btn-secondary">ê³ ê° í˜ì´ì§€ë¡œ</a>
            <a href="/admin/logout" class="btn-action btn-logout">ë¡œê·¸ì•„ì›ƒ</a>
        </div>
    </div>

    <!-- í•„í„° íƒ­ -->
    <div class="filter-tabs">
        <button class="filter-tab active" onclick="filterOrders('all')">ì „ì²´ <span class="tab-count" id="count-all">0</span></button>
        <button class="filter-tab" onclick="filterOrders('pending')">ëŒ€ê¸°ì¤‘ <span class="tab-count" id="count-pending">0</span></button>
        <button class="filter-tab" onclick="filterOrders('completed')">ì™„ë£Œ <span class="tab-count" id="count-completed">0</span></button>
    </div>

    <!-- ì„ íƒ ì•¡ì…˜ ë°” -->
    <div class="bulk-actions" id="bulk-actions" style="display:none;">
        <span id="selected-count">0ê°œ ì„ íƒ</span>
        <button onclick="bulkUpdateStatus('completed')" class="btn-action btn-complete">âœ… ì™„ë£Œ ì²˜ë¦¬</button>
        <button onclick="bulkUpdateStatus('pending')" class="btn-action btn-revert">â†©ï¸ ëŒ€ê¸° ì²˜ë¦¬</button>
        <button onclick="downloadSelected()" class="btn-action btn-download-csv">ğŸ“¥ ì„ íƒ ë‹¤ìš´ë¡œë“œ</button>
        <a href="/admin/orders/download" class="btn-action btn-download-all">ğŸ“¥ ì „ì²´ ë‹¤ìš´ë¡œë“œ</a>
    </div>

    <div class="orders-list">
        {% if orders %}
        <table class="admin-table">
            <thead>
                <tr>
                    <th class="col-check"><input type="checkbox" id="select-all" onchange="toggleSelectAll()"></th>
                    <th class="col-no">No.</th>
                    <th class="col-name">ê³ ê°</th>
                    <th class="col-phone">ì—°ë½ì²˜</th>
                    <th class="col-size">í¬ê¸°</th>
                    <th class="col-qty">ìˆ˜ëŸ‰</th>
                    <th class="col-price">ê¸ˆì•¡</th>
                    <th class="col-file">ğŸ“</th>
                    <th class="col-status">ìƒíƒœ</th>
                    <th class="col-date">ì¼ì‹œ</th>
                    <th class="col-action"></th>
                </tr>
            </thead>
            <tbody id="orders-tbody">
                {% for order in orders %}
                <tr data-order-id="{{ order.order_id }}" data-status="{{ order.status }}" class="order-row">
                    <td><input type="checkbox" class="order-check" value="{{ order.order_id }}" onchange="updateBulkActions()"></td>
                    <td><strong>{{ order.order_id[-4:] }}</strong></td>
                    <td>{{ order.customer_name }}</td>
                    <td>{{ order.customer_phone }}</td>
                    <td>{{ order.width }}Ã—{{ order.height }}mm</td>
                    <td>{{ order.quantity }}ê°œ</td>
                    <td><strong>{{ "{:,}".format(order.total_price) }}ì›</strong></td>
                    <td>{% if order.file_path %}<span class="file-link" onclick="showPreview('{{ order.file_path }}', '{{ order.order_id }}')">ğŸ“</span>{% else %}-{% endif %}</td>

                    <td>
                        <span class="status-badge status-{{ order.status }}">
                            {% if order.status == 'pending' %}ëŒ€ê¸°ì¤‘{% elif order.status == 'completed' %}ì™„ë£Œ{% else %}{{ order.status }}{% endif %}
                        </span>
                    </td>
                    <td>{{ order.created_at[5:16] }}</td>
                    <td>
                        <a href="/admin/orders/{{ order.order_id }}" class="btn-view">ë³´ê¸°</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <p>ì•„ì§ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
<div class="preview-modal" id="preview-modal" onclick="closePreview(event)">
    <div class="preview-content">
        <div class="preview-header">
            <span id="preview-title">ì²¨ë¶€íŒŒì¼</span>
            <button onclick="document.getElementById('preview-modal').style.display='none'" class="preview-close">&times;</button>
        </div>
        <div class="preview-body" id="preview-body"></div>
        <div class="preview-footer">
            <a id="preview-download" href="#" download class="btn-action btn-download-csv">ğŸ’¾ ë‹¤ìš´ë¡œë“œ</a>
        </div>
    </div>
</div>

<script>
function showPreview(filePath, orderId) {
    var ext = filePath.split('.').pop().toLowerCase();
    var body = document.getElementById('preview-body');
    document.getElementById('preview-title').textContent = orderId + ' ì²¨ë¶€íŒŒì¼';
    document.getElementById('preview-download').href = '/admin/orders/' + orderId + '/file';

    if (['png','jpg','jpeg','gif','bmp'].indexOf(ext) >= 0) {
        body.innerHTML = '<img src="' + filePath + '" class="preview-img">';
    } else {
        body.innerHTML = '<div class="preview-file-info"><span class="preview-ext">.' + ext.toUpperCase() + '</span><p>ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ì…ë‹ˆë‹¤</p></div>';
    }
    document.getElementById('preview-modal').style.display = 'flex';
}

function closePreview(e) {
    if (e.target === document.getElementById('preview-modal')) {
        document.getElementById('preview-modal').style.display = 'none';
    }
}

var currentFilter = 'all';

function filterOrders(status) {
    currentFilter = status;
    var rows = document.querySelectorAll('.order-row');
    rows.forEach(function(row) {
        if (status === 'all' || row.dataset.status === status) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });

    // íƒ­ í™œì„±í™”
    document.querySelectorAll('.filter-tab').forEach(function(tab) { tab.classList.remove('active'); });
    event.target.closest('.filter-tab').classList.add('active');

    // ì „ì²´ ì„ íƒ í•´ì œ
    document.getElementById('select-all').checked = false;
    document.querySelectorAll('.order-check').forEach(function(cb) { cb.checked = false; });
    updateBulkActions();
}

function toggleSelectAll() {
    var checked = document.getElementById('select-all').checked;
    document.querySelectorAll('.order-row').forEach(function(row) {
        if (row.style.display !== 'none') {
            row.querySelector('.order-check').checked = checked;
        }
    });
    updateBulkActions();
}

function getSelectedIds() {
    var ids = [];
    document.querySelectorAll('.order-check:checked').forEach(function(cb) {
        ids.push(cb.value);
    });
    return ids;
}

function updateBulkActions() {
    var ids = getSelectedIds();
    var bar = document.getElementById('bulk-actions');
    bar.style.display = ids.length > 0 ? 'flex' : 'none';
    document.getElementById('selected-count').textContent = ids.length + 'ê°œ ì„ íƒ';
}

function bulkUpdateStatus(status) {
    var ids = getSelectedIds();
    if (ids.length === 0) return;

    fetch('/admin/orders/bulk-status', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({order_ids: ids, status: status})
    }).then(function(res) {
        if (res.ok) location.reload();
    });
}

function downloadSelected() {
    var ids = getSelectedIds();
    if (ids.length === 0) return;
    window.location.href = '/admin/orders/download?ids=' + ids.join(',');
}

// ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
(function() {
    var rows = document.querySelectorAll('.order-row');
    var total = 0, pending = 0, completed = 0;
    rows.forEach(function(row) {
        total++;
        if (row.dataset.status === 'pending') pending++;
        else if (row.dataset.status === 'completed') completed++;
    });
    document.getElementById('count-all').textContent = total;
    document.getElementById('count-pending').textContent = pending;
    document.getElementById('count-completed').textContent = completed;
})();
</script>

<style>
.admin-container {
    max-width: 100%;
    margin: 0 auto;
    padding: 20px;
}

.admin-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    background: white;
    padding: 24px;
    border-radius: 12px;
}

.admin-header h1 {
    color: #5C5C5C;
    margin: 0;
}

.admin-actions {
    display: flex;
    gap: 12px;
}

.btn-action {
    padding: 8px 14px;
    border-radius: 6px;
    text-decoration: none;
    font-weight: 600;
    font-size: 13px;
    border: none;
    cursor: pointer;
    white-space: nowrap;
}

.btn-secondary { background: #f0f0f0; color: #333; }
.btn-logout { background: #ff4444; color: white; }
.btn-download-csv { background: #28a745; color: white; }
.btn-download-all { background: #17a2b8; color: white; }
.btn-complete { background: #28a745; color: white; }
.btn-revert { background: #6c757d; color: white; }

/* í•„í„° íƒ­ */
.filter-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
}

.filter-tab {
    padding: 10px 20px;
    background: white;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    color: #666;
    cursor: pointer;
    transition: all 0.2s;
}

.filter-tab.active {
    border-color: #F4B900;
    background: #fffbf0;
    color: #333;
}

.tab-count {
    display: inline-block;
    background: #e0e0e0;
    color: #666;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 12px;
    margin-left: 4px;
}

.filter-tab.active .tab-count {
    background: #F4B900;
    color: #1A1A1A;
}

/* ì„ íƒ ì•¡ì…˜ ë°” */
.bulk-actions {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 8px;
    padding: 12px 16px;
    background: #333;
    color: white;
    border-radius: 10px;
    margin-bottom: 16px;
    font-size: 13px;
    font-weight: 600;
}

#selected-count {
    margin-right: auto;
}

/* í…Œì´ë¸” */
.orders-list {
    background: white;
    border-radius: 12px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

.admin-table {
    width: 100%;
    border-collapse: collapse;
}

.admin-table thead {
    background: #f8f9fa;
}

.admin-table th,
.admin-table td {
    padding: 12px 12px;
    text-align: left;
    font-size: 14px;
    white-space: nowrap;
}

.admin-table th {
    font-weight: 600;
    color: #5C5C5C;
    border-bottom: 2px solid #e0e0e0;
}

.admin-table td {
    border-bottom: 1px solid #f0f0f0;
}

/* ì»¬ëŸ¼ ì •ë ¬ */
.admin-table .col-check { text-align: center; }
.admin-table .col-file { text-align: center; }

.order-check, #select-all {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: #F4B900;
}

.order-row[data-status="completed"] {
    opacity: 0.6;
    background: #f9f9f9;
}

.status-badge {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
}

.status-pending {
    background: #fff3cd;
    color: #856404;
}

.status-completed {
    background: #d4edda;
    color: #155724;
}

.btn-view {
    padding: 6px 14px;
    background: #F4B900;
    color: #1A1A1A;
    text-decoration: none;
    border-radius: 6px;
    font-weight: 600;
    font-size: 13px;
}

.empty-state {
    padding: 60px;
    text-align: center;
    color: #999;
}

.file-link {
    cursor: pointer;
    font-size: 18px;
    transition: transform 0.2s;
    display: inline-block;
}
.file-link:hover { transform: scale(1.3); }

/* ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ */
.preview-modal {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.6);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}

.preview-content {
    background: white;
    border-radius: 12px;
    max-width: 700px;
    width: 90%;
    max-height: 85vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid #e0e0e0;
    font-weight: 700;
    font-size: 16px;
}

.preview-close {
    background: none;
    border: none;
    font-size: 28px;
    cursor: pointer;
    color: #999;
    line-height: 1;
}
.preview-close:hover { color: #333; }

.preview-body {
    padding: 20px;
    text-align: center;
    overflow-y: auto;
    flex: 1;
}

.preview-img {
    max-width: 100%;
    max-height: 60vh;
    border-radius: 8px;
}

.preview-file-info {
    padding: 40px;
    color: #666;
}

.preview-ext {
    display: inline-block;
    background: #f0f0f0;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 24px;
    font-weight: 700;
    color: #333;
    margin-bottom: 12px;
}

.preview-footer {
    padding: 16px 20px;
    border-top: 1px solid #e0e0e0;
    text-align: right;
}

/* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
@media (max-width: 600px) {
    .admin-container {
        padding: 10px;
    }
    .admin-header {
        flex-direction: column;
        gap: 12px;
        padding: 16px;
        text-align: center;
    }
    .admin-header h1 {
        font-size: 18px;
    }
    .admin-actions {
        width: 100%;
        justify-content: center;
    }
    .filter-tabs {
        flex-wrap: wrap;
    }
    .filter-tab {
        padding: 8px 14px;
        font-size: 13px;
        flex: 1;
        text-align: center;
    }
    .bulk-actions {
        justify-content: center;
        text-align: center;
    }
    #selected-count {
        width: 100%;
        text-align: center;
        margin-right: 0;
    }
    .admin-table {
        min-width: 700px;
    }
    .admin-table th,
    .admin-table td {
        padding: 10px 8px;
        font-size: 12px;
    }
    .orders-list {
        border-radius: 8px;
    }
    .orders-list::after {
        content: 'â† ì¢Œìš°ë¡œ ìŠ¤í¬ë¡¤ â†’';
        display: block;
        text-align: center;
        padding: 8px;
        font-size: 11px;
        color: #999;
        background: #f8f9fa;
    }
}
</style>
{% endblock %}
