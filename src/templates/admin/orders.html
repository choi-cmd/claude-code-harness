{% extends "base.html" %}
{% block pwa %}
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Custom Order">
    <link rel="apple-touch-icon" href="/static/images/icon-192.png">
    <link rel="manifest" href="/static/manifest-admin.json">
{% endblock %}
{% block pwa_script %}{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header">
        <h1>&#x1f4e6; 주문 관리</h1>
        <div class="admin-actions">
            <a href="/admin/" class="btn-action btn-nav">대시보드</a>
            <a href="/" class="btn-action btn-secondary">고객 페이지로</a>
            <a href="/admin/logout" class="btn-action btn-logout">로그아웃</a>
        </div>
    </div>

    <div class="admin-nav">
        <a href="/admin/" class="nav-tab">대시보드</a>
        <a href="/admin/orders" class="nav-tab active">주문 관리</a>
    </div>

    <!-- 필터 탭 -->
    <div class="filter-tabs">
        <button class="filter-tab active" onclick="filterOrders('all')">전체 <span class="tab-count" id="count-all">0</span></button>
        <button class="filter-tab" onclick="filterOrders('pending')">대기중 <span class="tab-count" id="count-pending">0</span></button>
        <button class="filter-tab" onclick="filterOrders('completed')">완료 <span class="tab-count" id="count-completed">0</span></button>
    </div>

    <!-- 선택 액션 바 -->
    <div class="bulk-actions" id="bulk-actions" style="display:none;">
        <span id="selected-count">0개 선택</span>
        <button onclick="bulkUpdateStatus('completed')" class="btn-action btn-complete">&#x2705; 완료 처리</button>
        <button onclick="bulkUpdateStatus('pending')" class="btn-action btn-revert">&#x21a9;&#xfe0f; 대기 처리</button>
        <button onclick="downloadSelected()" class="btn-action btn-download-csv">&#x1f4e5; 선택 다운로드</button>
        <a href="/admin/orders/download" class="btn-action btn-download-all">&#x1f4e5; 전체 다운로드</a>
    </div>

    <div class="orders-list">
        {% if orders %}
        <table class="admin-table">
            <thead>
                <tr>
                    <th class="col-check"><input type="checkbox" id="select-all" onchange="toggleSelectAll()"></th>
                    <th class="col-no">No.</th>
                    <th class="col-name">고객</th>
                    <th class="col-phone">연락처</th>
                    <th class="col-size">크기</th>
                    <th class="col-qty">수량</th>
                    <th class="col-price">금액</th>
                    <th class="col-file">&#x1f4ce;</th>
                    <th class="col-status">상태</th>
                    <th class="col-date">일시</th>
                    <th class="col-action"></th>
                </tr>
            </thead>
            <tbody id="orders-tbody">
                {% for order in orders %}
                <tr data-order-id="{{ order.order_id }}" data-status="{{ order.status }}" class="order-row">
                    <td><input type="checkbox" class="order-check" value="{{ order.order_id }}" onchange="updateBulkActions()"></td>
                    <td><strong>{{ order.order_id[-4:] }}</strong></td>
                    <td>{{ order.customer_name }}</td>
                    <td>{{ order.customer_phone }}</td>
                    <td>{{ order.width }}&times;{{ order.height }}mm</td>
                    <td>{{ order.quantity }}개</td>
                    <td><strong>{{ "{:,}".format(order.total_price) }}원</strong></td>
                    <td>{% if order.file_path %}<span class="file-link" onclick="showPreview('{{ order.file_path }}', '{{ order.order_id }}')">&#x1f4ce;</span>{% else %}-{% endif %}</td>

                    <td>
                        <span class="status-badge status-{{ order.status }}">
                            {% if order.status == 'pending' %}대기중{% elif order.status == 'completed' %}완료{% else %}{{ order.status }}{% endif %}
                        </span>
                    </td>
                    <td>{{ order.created_at[5:16] }}</td>
                    <td>
                        <a href="/admin/orders/{{ order.order_id }}" class="btn-view">보기</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <p>아직 주문이 없습니다.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- 미리보기 모달 -->
<div class="preview-modal" id="preview-modal" onclick="closePreview(event)">
    <div class="preview-content">
        <div class="preview-header">
            <span id="preview-title">첨부파일</span>
            <button onclick="document.getElementById('preview-modal').style.display='none'" class="preview-close">&times;</button>
        </div>
        <div class="preview-body" id="preview-body"></div>
        <div class="preview-footer">
            <a id="preview-download" href="#" download class="btn-action btn-download-csv">&#x1f4be; 다운로드</a>
        </div>
    </div>
</div>

<script>
function showPreview(filePath, orderId) {
    var ext = filePath.split('.').pop().toLowerCase();
    var body = document.getElementById('preview-body');
    document.getElementById('preview-title').textContent = orderId + ' 첨부파일';
    document.getElementById('preview-download').href = '/admin/orders/' + orderId + '/file';

    if (['png','jpg','jpeg','gif','bmp'].indexOf(ext) >= 0) {
        body.innerHTML = '<img src="' + filePath + '" class="preview-img">';
    } else {
        body.innerHTML = '<div class="preview-file-info"><span class="preview-ext">.' + ext.toUpperCase() + '</span><p>미리보기를 지원하지 않는 파일입니다</p></div>';
    }
    document.getElementById('preview-modal').style.display = 'flex';
}

function closePreview(e) {
    if (e.target === document.getElementById('preview-modal')) {
        document.getElementById('preview-modal').style.display = 'none';
    }
}

var currentFilter = 'all';

function filterOrders(status) {
    currentFilter = status;
    var rows = document.querySelectorAll('.order-row');
    rows.forEach(function(row) {
        if (status === 'all' || row.dataset.status === status) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });

    // 탭 활성화
    document.querySelectorAll('.filter-tab').forEach(function(tab) { tab.classList.remove('active'); });
    event.target.closest('.filter-tab').classList.add('active');

    // 전체 선택 해제
    document.getElementById('select-all').checked = false;
    document.querySelectorAll('.order-check').forEach(function(cb) { cb.checked = false; });
    updateBulkActions();
}

function toggleSelectAll() {
    var checked = document.getElementById('select-all').checked;
    document.querySelectorAll('.order-row').forEach(function(row) {
        if (row.style.display !== 'none') {
            row.querySelector('.order-check').checked = checked;
        }
    });
    updateBulkActions();
}

function getSelectedIds() {
    var ids = [];
    document.querySelectorAll('.order-check:checked').forEach(function(cb) {
        ids.push(cb.value);
    });
    return ids;
}

function updateBulkActions() {
    var ids = getSelectedIds();
    var bar = document.getElementById('bulk-actions');
    bar.style.display = ids.length > 0 ? 'flex' : 'none';
    document.getElementById('selected-count').textContent = ids.length + '개 선택';
}

function bulkUpdateStatus(status) {
    var ids = getSelectedIds();
    if (ids.length === 0) return;

    fetch('/admin/orders/bulk-status', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({order_ids: ids, status: status})
    }).then(function(res) {
        if (res.ok) location.reload();
    });
}

function downloadSelected() {
    var ids = getSelectedIds();
    if (ids.length === 0) return;
    window.location.href = '/admin/orders/download?ids=' + ids.join(',');
}

// 카운트 업데이트
(function() {
    var rows = document.querySelectorAll('.order-row');
    var total = 0, pending = 0, completed = 0;
    rows.forEach(function(row) {
        total++;
        if (row.dataset.status === 'pending') pending++;
        else if (row.dataset.status === 'completed') completed++;
    });
    document.getElementById('count-all').textContent = total;
    document.getElementById('count-pending').textContent = pending;
    document.getElementById('count-completed').textContent = completed;
})();
</script>

<style>
.admin-container {
    max-width: 100%;
    margin: 0 auto;
    padding: 20px;
}

.admin-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0;
    background: linear-gradient(135deg, #1E1E1E 0%, #2A2A2A 100%);
    padding: 24px 28px;
    border-radius: var(--radius-lg) var(--radius-lg) 0 0;
    border-bottom: 3px solid var(--gold-400);
    box-shadow: 0 4px 16px rgba(0,0,0,0.3);
}

.admin-header h1 {
    color: #FFFFFF;
    margin: 0;
    font-size: 22px;
    font-weight: 800;
    letter-spacing: -0.02em;
}

.admin-actions {
    display: flex;
    gap: 10px;
}

.btn-action {
    padding: 8px 16px;
    border-radius: var(--radius-sm);
    text-decoration: none;
    font-weight: 600;
    font-size: 13px;
    font-family: var(--font-main);
    border: none;
    cursor: pointer;
    white-space: nowrap;
    transition: all var(--transition-fast);
}

.btn-secondary { background: rgba(255,255,255,0.12); color: rgba(255,255,255,0.85); }
.btn-secondary:hover { background: rgba(255,255,255,0.2); color: #fff; }
.btn-logout { background: rgba(255,68,68,0.85); color: white; }
.btn-logout:hover { background: #ff4444; }
.btn-nav { background: var(--gold-gradient); color: var(--gray-900); box-shadow: 0 2px 6px rgba(244,185,0,0.3); }
.btn-nav:hover { box-shadow: var(--shadow-gold); transform: translateY(-1px); }
.btn-download-csv { background: #28a745; color: white; }
.btn-download-all { background: #17a2b8; color: white; }
.btn-complete { background: #28a745; color: white; }
.btn-revert { background: var(--gray-600); color: white; }

.admin-nav {
    display: flex;
    gap: 0;
    background: #242424;
    padding: 0 28px;
    border-bottom: none;
    border-radius: 0 0 var(--radius-lg) var(--radius-lg);
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.nav-tab {
    padding: 13px 22px;
    text-decoration: none;
    font-weight: 600;
    font-size: 14px;
    color: rgba(255,255,255,0.45);
    border-bottom: 3px solid transparent;
    margin-bottom: -1px;
    transition: all var(--transition-normal);
}

.nav-tab:hover { color: rgba(255,255,255,0.8); }
.nav-tab.active { color: var(--gold-400); border-bottom-color: var(--gold-400); font-weight: 700; }

/* 필터 탭 */
.filter-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
}

.filter-tab {
    padding: 10px 20px;
    background: rgba(255,255,255,0.06);
    border: 2px solid rgba(255,255,255,0.1);
    border-radius: var(--radius-sm);
    font-size: 14px;
    font-weight: 600;
    font-family: var(--font-main);
    color: rgba(255,255,255,0.55);
    cursor: pointer;
    transition: all var(--transition-normal);
}

.filter-tab:hover {
    background: rgba(255,255,255,0.1);
    color: rgba(255,255,255,0.8);
}

.filter-tab.active {
    border-color: var(--gold-400);
    background: rgba(244, 185, 0, 0.1);
    color: var(--gold-400);
}

.tab-count {
    display: inline-block;
    background: rgba(255,255,255,0.1);
    color: rgba(255,255,255,0.5);
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 12px;
    margin-left: 4px;
}

.filter-tab.active .tab-count {
    background: var(--gold-400);
    color: var(--gray-900);
}

/* 선택 액션 바 */
.bulk-actions {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 8px;
    padding: 12px 16px;
    background: linear-gradient(135deg, #1E1E1E 0%, #2A2A2A 100%);
    color: white;
    border-radius: var(--radius-md);
    margin-bottom: 16px;
    font-size: 13px;
    font-weight: 600;
    border: 1px solid rgba(244, 185, 0, 0.2);
    box-shadow: var(--shadow-md);
}

#selected-count {
    margin-right: auto;
    color: var(--gold-400);
}

/* 테이블 */
.orders-list {
    background: linear-gradient(180deg, #FFFFFF 0%, #FDFCF8 100%);
    border-radius: var(--radius-lg);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    box-shadow: var(--shadow-lg);
    border: 1px solid rgba(244, 185, 0, 0.1);
}

.admin-table {
    width: 100%;
    border-collapse: collapse;
}

.admin-table thead {
    background: linear-gradient(135deg, #1E1E1E 0%, #2A2A2A 100%);
}

.admin-table th {
    padding: 14px 12px;
    text-align: left;
    font-size: 13px;
    font-weight: 700;
    color: rgba(255,255,255,0.75);
    border-bottom: 2px solid var(--gold-400);
    letter-spacing: 0.02em;
    white-space: nowrap;
}

.admin-table td {
    padding: 13px 12px;
    text-align: left;
    font-size: 14px;
    white-space: nowrap;
    border-bottom: 1px solid var(--gray-100);
    color: var(--gray-800);
}

.admin-table tbody tr {
    transition: background var(--transition-fast);
}

.admin-table tbody tr:nth-child(even) {
    background: var(--gray-50);
}

.admin-table tbody tr:hover {
    background: var(--gold-50);
}

.admin-table .col-check { text-align: center; }
.admin-table .col-file { text-align: center; }

.order-check, #select-all {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: var(--gold-400);
}

.order-row[data-status="completed"] {
    opacity: 0.55;
    background: var(--gray-50);
}

.status-badge {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 700;
}

.status-pending {
    background: #fff3cd;
    color: #856404;
}

.status-completed {
    background: #d4edda;
    color: #155724;
}

.btn-view {
    padding: 6px 14px;
    background: var(--gold-gradient);
    color: var(--gray-900);
    text-decoration: none;
    border-radius: var(--radius-sm);
    font-weight: 700;
    font-size: 13px;
    transition: all var(--transition-normal);
    box-shadow: 0 1px 4px rgba(244,185,0,0.15);
}

.btn-view:hover {
    box-shadow: var(--shadow-gold);
    transform: translateY(-1px);
}

.empty-state {
    padding: 60px;
    text-align: center;
    color: var(--gray-400);
    font-size: 15px;
}

.file-link {
    cursor: pointer;
    font-size: 18px;
    transition: transform 0.2s;
    display: inline-block;
}
.file-link:hover { transform: scale(1.3); }

/* 미리보기 모달 */
.preview-modal {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7);
    z-index: 1000;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(4px);
}

.preview-content {
    background: linear-gradient(180deg, #FFFFFF 0%, #FDFCF8 100%);
    border-radius: var(--radius-lg);
    max-width: 700px;
    width: 90%;
    max-height: 85vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    box-shadow: var(--shadow-xl);
    border: 1px solid rgba(244, 185, 0, 0.15);
}

.preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid var(--gray-200);
    font-weight: 700;
    font-size: 16px;
    color: var(--gray-800);
}

.preview-close {
    background: none;
    border: none;
    font-size: 28px;
    cursor: pointer;
    color: var(--gray-400);
    line-height: 1;
    transition: color var(--transition-fast);
}
.preview-close:hover { color: var(--gray-800); }

.preview-body {
    padding: 20px;
    text-align: center;
    overflow-y: auto;
    flex: 1;
}

.preview-img {
    max-width: 100%;
    max-height: 60vh;
    border-radius: var(--radius-sm);
}

.preview-file-info {
    padding: 40px;
    color: var(--gray-500);
}

.preview-ext {
    display: inline-block;
    background: var(--gray-100);
    padding: 12px 24px;
    border-radius: var(--radius-sm);
    font-size: 24px;
    font-weight: 700;
    color: var(--gray-800);
    margin-bottom: 12px;
}

.preview-footer {
    padding: 16px 20px;
    border-top: 1px solid var(--gray-200);
    text-align: right;
}

@media (max-width: 600px) {
    .admin-container {
        padding: 10px;
    }
    .admin-header {
        flex-direction: column;
        gap: 12px;
        padding: 16px;
        text-align: center;
    }
    .admin-header h1 {
        font-size: 18px;
    }
    .admin-actions {
        width: 100%;
        justify-content: center;
    }
    .filter-tabs {
        flex-wrap: wrap;
    }
    .filter-tab {
        padding: 8px 14px;
        font-size: 13px;
        flex: 1;
        text-align: center;
    }
    .bulk-actions {
        justify-content: center;
        text-align: center;
    }
    #selected-count {
        width: 100%;
        text-align: center;
        margin-right: 0;
    }
    .admin-table {
        min-width: 700px;
    }
    .admin-table th,
    .admin-table td {
        padding: 10px 8px;
        font-size: 12px;
    }
    .orders-list {
        border-radius: var(--radius-sm);
    }
    .orders-list::after {
        content: '\2190 좌우로 스크롤 \2192';
        display: block;
        text-align: center;
        padding: 8px;
        font-size: 11px;
        color: var(--gray-400);
        background: var(--gray-50);
    }
}
</style>
{% endblock %}
