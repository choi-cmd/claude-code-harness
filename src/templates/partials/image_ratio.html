{% set max_width = 406 %}
{% set max_height = 609 %}
{% set too_large = (result.target_width|int > max_width) or (result.target_height|int > max_height) %}

{% if too_large %}
<div class="ratio-result-card ratio-error">
    <h3>âŒ ì œì‘ ë¶ˆê°€ í¬ê¸°</h3>

    {% if cutting_preview_path %}
    <div class="result-preview-wrap cutting-preview">
        <img src="{{ cutting_preview_path }}" alt="ì¬ë‹¨/ì¸ì‡„ ë¼ì¸ ë¯¸ë¦¬ë³´ê¸°">
        <div class="cutting-legend">
            <span class="legend-item legend-print">ë¹¨ê°„ = ì¸ì‡„ ë¼ì¸</span>
            <span class="legend-item legend-cutting">ê²€ì • = ì¬ë‹¨ ë¼ì¸</span>
            {% if product_type == 'keyring' %}
            <span class="legend-item legend-hole">ì´ˆë¡ = {% if hole_type == 'internal' %}ë‚´ë¶€ íƒ€ê³µ{% else %}ê³ ë¦¬ êµ¬ë©{% endif %}</span>
            {% endif %}
        </div>
    </div>
    {% elif outline_path %}
    <div class="result-preview-wrap outline-preview">
        <img src="{{ outline_path }}" alt="ì¬ë‹¨ ì•„ì›ƒë¼ì¸ ë¯¸ë¦¬ë³´ê¸°">
        <div class="outline-label">ë¹¨ê°„ ì„  = ì•„í¬ë¦´ ì¬ë‹¨ ë¼ì¸</div>
    </div>
    {% elif preview_path %}
    <div class="result-preview-wrap">
        <img src="{{ preview_path }}" alt="ë°°ê²½ ì œê±° ë¯¸ë¦¬ë³´ê¸°">
    </div>
    {% elif file_path and not file_path.endswith(('.ai', '.psd')) %}
    <div class="result-preview-wrap">
        <img src="{{ file_path }}" alt="ì—…ë¡œë“œ ì´ë¯¸ì§€">
    </div>
    {% endif %}

    <div class="info-badge error">
        <span class="badge-icon">ğŸš«</span>
        <span>ì´ë¯¸ì§€ í¬ê¸°ê°€ ì œì‘ ê°€ëŠ¥ ë²”ìœ„ë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤. ë‹¤ë¥¸ íŒŒì¼ì„ ì²¨ë¶€í•˜ê±°ë‚˜ í¬ê¸°ë¥¼ ì§€ì •í•´ì£¼ì„¸ìš”.</span>
    </div>

    <div class="ratio-info">
        <div class="ratio-item">
            <span class="label">{% if is_transparent %}ì‹¤ì œ ê°ì²´ í¬ê¸°:{% else %}ì›ë³¸ í¬ê¸°:{% endif %}</span>
            <span class="value">{{ result.original_width|int }} Ã— {{ result.original_height|int }} px</span>
        </div>
        <div class="ratio-item highlight-box error-box">
            <span class="label">ê³„ì‚°ëœ í¬ê¸°:</span>
            <span class="value"><strong>{{ result.target_width|int }}mm Ã— {{ result.target_height|int }}mm</strong></span>
        </div>
        <div class="ratio-item">
            <span class="label">ìµœëŒ€ ì œì‘ í¬ê¸°:</span>
            <span class="value">{{ max_width }}mm Ã— {{ max_height }}mm</span>
        </div>
    </div>

    <p class="hint">ê¸°ì¤€ ë°©í–¥ì„ ì„ íƒí•˜ê³  ì›í•˜ëŠ” í¬ê¸°ë¥¼ ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜, ë” ì‘ì€ ì´ë¯¸ì§€ë¥¼ ì²¨ë¶€í•´ì£¼ì„¸ìš”.</p>
</div>

{% else %}
<div class="ratio-result-card">
    <h3>ë¹„ìœ¨ ê³„ì‚° ì™„ë£Œ</h3>

    {% if cutting_preview_path %}
    <div class="result-preview-wrap cutting-preview" id="cutting-preview-area">
        <img src="{{ cutting_preview_path }}" alt="ì¬ë‹¨/ì¸ì‡„ ë¼ì¸ ë¯¸ë¦¬ë³´ê¸°">
        <div class="cutting-legend">
            <span class="legend-item legend-print">ë¹¨ê°„ = ì¸ì‡„ ë¼ì¸</span>
            <span class="legend-item legend-cutting">ê²€ì • = ì¬ë‹¨ ë¼ì¸</span>
            {% if product_type == 'keyring' %}
            <span class="legend-item legend-hole">ì´ˆë¡ = {% if hole_type == 'internal' %}ë‚´ë¶€ íƒ€ê³µ{% else %}ê³ ë¦¬ êµ¬ë©{% endif %}</span>
            {% endif %}
        </div>
    </div>
    {% elif outline_path %}
    <div class="result-preview-wrap outline-preview">
        <img src="{{ outline_path }}" alt="ì¬ë‹¨ ì•„ì›ƒë¼ì¸ ë¯¸ë¦¬ë³´ê¸°">
        <div class="outline-label">ë¹¨ê°„ ì„  = ì•„í¬ë¦´ ì¬ë‹¨ ë¼ì¸</div>
    </div>
    {% elif preview_path %}
    <div class="result-preview-wrap">
        <img src="{{ preview_path }}" alt="ë°°ê²½ ì œê±° ë¯¸ë¦¬ë³´ê¸°">
    </div>
    {% elif file_path and not file_path.endswith(('.ai', '.psd')) %}
    <div class="result-preview-wrap">
        <img src="{{ file_path }}" alt="ì—…ë¡œë“œ ì´ë¯¸ì§€">
    </div>
    {% elif file_path %}
    <div class="result-preview-noimage">
        <span>{{ file_path.split('/')[-1] }}</span>
        <small>ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤</small>
    </div>
    {% endif %}

    {% if is_manual_mask %}
    <div class="info-badge">
        <span class="badge-icon">âœï¸</span>
        <span>ì§ì ‘ ì„ íƒí•œ ì˜ì—­ìœ¼ë¡œ ê³„ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤</span>
    </div>
    {% elif rembg_used %}
    <div class="info-badge">
        <span class="badge-icon">ğŸ¤–</span>
        <span>AIê°€ ë°°ê²½ì„ ì œê±°í•˜ê³  ì¬ë‹¨/ì¸ì‡„ ë¼ì¸ì„ ìë™ ìƒì„±í–ˆìŠµë‹ˆë‹¤</span>
    </div>
    {% elif is_transparent %}
    <div class="info-badge">
        <span class="badge-icon">ğŸ¯</span>
        <span>íˆ¬ëª… ë°°ê²½ ì œì™¸í•œ ì‹¤ì œ ê°ì²´ í¬ê¸°ë¡œ ê³„ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤</span>
    </div>
    {% else %}
    <div class="info-badge warning">
        <span class="badge-icon">âš ï¸</span>
        <span>ì „ì²´ ì´ë¯¸ì§€ í¬ê¸°ë¡œ ê³„ì‚°ë¨ (PNG íˆ¬ëª… ë°°ê²½ ê¶Œì¥)</span>
    </div>
    {% endif %}

    <div class="ratio-info">
        <div class="ratio-item">
            <span class="label">{% if is_transparent %}ì‹¤ì œ ê°ì²´ í¬ê¸°:{% else %}ì›ë³¸ í¬ê¸°:{% endif %}</span>
            <span class="value">{{ result.original_width|int }} Ã— {{ result.original_height|int }} px</span>
        </div>
        <div class="ratio-item">
            <span class="label">ë¹„ìœ¨:</span>
            <span class="value">{{ result.ratio }}</span>
        </div>
        <div class="ratio-item highlight-box">
            <span class="label">{% if product_type == 'keyring' and hole_type != 'internal' %}ì „ì²´ í¬ê¸° (ê³ ë¦¬ í¬í•¨):{% elif result.target_dimension == 'auto' %}ì´ë¯¸ì§€ ê¸°ì¤€ í¬ê¸°:{% else %}ê³„ì‚°ëœ í¬ê¸° ({% if result.target_dimension == 'height' %}ì„¸ë¡œ{% else %}ê°€ë¡œ{% endif %} ê¸°ì¤€):{% endif %}</span>
            <span class="value"><strong>{{ result.target_width|int }}mm Ã— {{ result.target_height|int }}mm</strong></span>
        </div>
    </div>

    {% if shape_analysis %}
    <!-- í˜•ìƒ ë¶„ì„ ê²°ê³¼ -->
    <div class="shape-analysis-section" id="shape-analysis-area">
        <h4>AI í˜•ìƒ ë¶„ì„{% if shape_analysis.cutting_perimeter_mm %} (ì¬ë‹¨ ë¼ì¸ ê¸°ì¤€){% endif %}</h4>
        <div class="shape-metrics-mini">
            {% if shape_analysis.cutting_perimeter_mm %}
            <div class="sm-row">
                <span class="sm-label">ì¬ë‹¨ ì•„ì›ƒë¼ì¸ ê¸¸ì´</span>
                <span class="sm-value">{{ "{:,.1f}".format(shape_analysis.cutting_perimeter_mm) }} mm</span>
            </div>
            <div class="sm-row">
                <span class="sm-label">ì¬ë‹¨ ë©´ì </span>
                <span class="sm-value">{{ "{:,.1f}".format(shape_analysis.cutting_area_mm2) }} mm2</span>
            </div>
            {% else %}
            <div class="sm-row">
                <span class="sm-label">ì•„ì›ƒë¼ì¸ ê¸¸ì´</span>
                <span class="sm-value">{{ "{:,.1f}".format(shape_analysis.perimeter_mm) }} mm</span>
            </div>
            <div class="sm-row">
                <span class="sm-label">ì‹¤ì œ ë©´ì </span>
                <span class="sm-value">{{ "{:,.1f}".format(shape_analysis.area_mm2) }} mm2</span>
            </div>
            {% endif %}
            <div class="sm-row">
                <span class="sm-label">ì±„ì›€ë¥ </span>
                <span class="sm-value">{{ shape_analysis.fill_pct }}%</span>
            </div>
        </div>

        <!-- ë³µì¡ë„ ë¯¸ë‹ˆ ê²Œì´ì§€ -->
        <div class="complexity-mini">
            <div class="cm-header">
                <span>ë³µì¡ë„</span>
                <span class="cm-grade grade-{{ shape_analysis.complexity_label }}">{{ shape_analysis.complexity_label }}</span>
            </div>
            <div class="cm-bar">
                <div class="cm-fill" style="width: {{ shape_analysis.complexity_pct|int }}%"></div>
            </div>
        </div>

        {% if shape_analysis.drilling_fee and shape_analysis.drilling_fee > 0 %}
        <div class="sm-row" style="margin-top:4px; padding:4px 8px;">
            <span class="sm-label">íƒ€ê³µë¹„ ({% if hole_type == 'internal' %}ë‚´ë¶€ íƒ€ê³µ{% else %}ê³ ë¦¬ êµ¬ë©{% endif %})</span>
            <span class="sm-value">+{{ shape_analysis.drilling_fee }}ì›/ê°œ</span>
        </div>
        {% endif %}

        <div class="shape-price-preview">
            <span class="spp-label">í˜•ìƒ ê¸°ë°˜ ë‹¨ê°€ (ì˜ˆìƒ){% if shape_analysis.drilling_fee and shape_analysis.drilling_fee > 0 %} <small style="color:#888;">(íƒ€ê³µë¹„ í¬í•¨)</small>{% endif %}</span>
            <span class="spp-value">{{ "{:,}".format(shape_analysis.unit_price) }}ì›</span>
        </div>
    </div>
    {% endif %}

    <!-- ì§ì ‘ ì˜ì—­ ì„ íƒ ë²„íŠ¼ (í•­ìƒ í‘œì‹œ, .ai/.psd ì œì™¸) -->
    {% if file_path and not file_path.endswith(('.ai', '.psd')) %}
    <div id="manual-select-trigger" class="manual-select-trigger">
        <button type="button" onclick="showManualSelector()" class="btn-manual-select">
            âœï¸ ì§ì ‘ ì˜ì—­ ì„ íƒí•˜ê¸°
        </button>
    </div>

    <!-- ìº”ë²„ìŠ¤ UI (ìˆ¨ê¹€) -->
    <div id="manual-canvas-container" class="manual-canvas-container" style="display:none;">
        <h4 class="canvas-title">ê°ì²´ ìœ¤ê³½ì„ ì„ ê·¸ë ¤ì£¼ì„¸ìš”</h4>
        <div class="canvas-mode-tabs">
            <button type="button" class="mode-tab active" data-mode="polygon" onclick="switchMode(this, 'polygon')">ë‹¤ê°í˜•</button>
            <button type="button" class="mode-tab" data-mode="freehand" onclick="switchMode(this, 'freehand')">í”„ë¦¬í•¸ë“œ</button>
        </div>
        <!-- ë˜ëŒë¦¬ê¸°/ì´ˆê¸°í™”: ìº”ë²„ìŠ¤ ìœ„ -->
        <div class="canvas-controls-top">
            <button type="button" onclick="polygonDrawer.undo()" class="btn-canvas btn-canvas-sm">â†© ë˜ëŒë¦¬ê¸°</button>
            <button type="button" onclick="polygonDrawer.reset()" class="btn-canvas btn-canvas-sm">ğŸ—‘ ì´ˆê¸°í™”</button>
        </div>
        <div class="canvas-wrap">
            <canvas id="polygon-canvas"></canvas>
        </div>
        <p class="canvas-help" id="canvas-help-text">í´ë¦­ìœ¼ë¡œ ê¼­ì§“ì ì„ ì¶”ê°€í•˜ì„¸ìš”. ì²« ì  ê·¼ì²˜ë¥¼ í´ë¦­í•˜ë©´ ìë™ìœ¼ë¡œ ë‹«í™ë‹ˆë‹¤.</p>
        <!-- ì™„ë£Œ/ì·¨ì†Œ: ìº”ë²„ìŠ¤ ì•„ë˜ -->
        <div class="canvas-controls">
            <button type="button" onclick="submitManualMask()" class="btn-canvas btn-canvas-primary">âœ… ì™„ë£Œ</button>
            <button type="button" onclick="hideManualSelector()" class="btn-canvas btn-canvas-cancel">ì·¨ì†Œ</button>
        </div>
    </div>
    {% endif %}

    <p class="hint">ì´ í¬ê¸°ê°€ ìë™ìœ¼ë¡œ ë‹¨ê°€ ê³„ì‚°ì— ì ìš©ë©ë‹ˆë‹¤</p>

    <!-- ìˆ¨ê²¨ì§„ inputìœ¼ë¡œ ê³„ì‚° í¼ì— ì „ë‹¬ -->
    <script>
        document.getElementById('width').value = {{ result.target_width }};
        document.getElementById('height').value = {{ result.target_height }};
        // ë¹„ìœ¨ ê³„ì‚°ìœ¼ë¡œ ì ìš©ëœ í¬ê¸°ëŠ” ìˆ˜ì • ë¶ˆê°€
        document.getElementById('width').readOnly = true;
        document.getElementById('height').readOnly = true;
        document.getElementById('width').classList.add('readonly-field');
        document.getElementById('height').classList.add('readonly-field');
        window.ratioLocked = true;
        // ë¹„ìœ¨ ê³„ì‚°ì—ì„œ ì—…ë¡œë“œí•œ íŒŒì¼ ê²½ë¡œ ì €ì¥
        window.ratioFilePath = '{{ file_path }}';
        // í˜•ìƒ ë¶„ì„ ì—¬ë¶€ ì €ì¥
        window.shapeAnalysisAvailable = {{ 'true' if shape_analysis else 'false' }};
        // ìˆ˜ë™ ë§ˆìŠ¤í¬ í´ë¦¬ê³¤ ì €ì¥ (ìˆìœ¼ë©´)
        {% if is_manual_mask %}
        window.manualPolygon = '{{ manual_polygon|default("") }}';
        {% else %}
        window.manualPolygon = '';
        {% endif %}
        // ì£¼ë¬¸ í¼ hidden inputì— ì§ì ‘ ì„¸íŒ…
        var ratioFileInput = document.getElementById('order_ratio_file');
        if (ratioFileInput) ratioFileInput.value = '{{ file_path }}';
        // ìë™ ì²¨ë¶€ í‘œì‹œ
        var autoAttached = document.getElementById('auto-attached-file');
        var autoName = document.getElementById('auto-attached-name');
        if (autoAttached && autoName) {
            autoName.textContent = '{{ filename }}';
            autoAttached.style.display = 'flex';
            document.getElementById('design_file').style.display = 'none';
            document.getElementById('design_file_hint').style.display = 'none';
        }
        // í˜•ìƒ ë¶„ì„ì´ ìˆìœ¼ë©´ ê³„ì‚° ë²„íŠ¼ í™œì„±í™”
        if (window.shapeAnalysisAvailable) {
            enableCalculateButton();
        }
        // ê³„ì‚° íŠ¸ë¦¬ê±°
        document.querySelector('.calculator-form').dispatchEvent(new Event('submit'));
    </script>
</div>
{% endif %}

<style>
.ratio-result-card {
    background: #fffdf5;
    border: 2px solid #F4B900;
    border-radius: 12px;
    padding: 20px;
    margin-top: 16px;
}

.ratio-result-card.ratio-error {
    background: #fff5f5;
    border-color: #ff4444;
}

.ratio-result-card h3 {
    color: #5C5C5C;
    margin-bottom: 16px;
    font-size: 16px;
}

.ratio-info {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.ratio-item {
    display: flex;
    justify-content: space-between;
    padding: 8px;
}

.ratio-item .label {
    color: #666;
}

.ratio-item .value {
    font-weight: 600;
    color: #333;
}

.highlight-box {
    background: #fff;
    border-radius: 8px;
    padding: 12px !important;
}

.highlight-box .value strong {
    color: #F4B900;
    font-size: 18px;
}

.error-box {
    background: #ffe0e0;
}

.error-box .value strong {
    color: #ff4444;
}

.hint {
    margin-top: 12px;
    font-size: 13px;
    color: #666;
    text-align: center;
}

.info-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px;
    background: #d4edda;
    border: 1px solid #c3e6cb;
    border-radius: 8px;
    margin-bottom: 16px;
    font-size: 13px;
    color: #155724;
}

.info-badge.warning {
    background: #fff3cd;
    border-color: #ffeaa7;
    color: #856404;
}

.info-badge.error {
    background: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
}

.badge-icon {
    font-size: 18px;
}

/* í˜•ìƒ ë¶„ì„ ì„¹ì…˜ */
.shape-analysis-section {
    margin-top: 16px;
    padding: 16px;
    background: #f0f7ff;
    border: 1px solid #b8d4f0;
    border-radius: 10px;
}

.shape-analysis-section h4 {
    font-size: 14px;
    color: #2c5282;
    margin-bottom: 12px;
}

.shape-metrics-mini {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-bottom: 12px;
}

.sm-row {
    display: flex;
    justify-content: space-between;
    font-size: 13px;
    padding: 4px 8px;
}

.sm-label {
    color: #4a6fa5;
}

.sm-value {
    font-weight: 600;
    color: #2c5282;
}

/* ë³µì¡ë„ ë¯¸ë‹ˆ ê²Œì´ì§€ */
.complexity-mini {
    margin-bottom: 12px;
    padding: 8px;
    background: #fff;
    border-radius: 6px;
}

.cm-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 13px;
    color: #555;
    margin-bottom: 6px;
}

.cm-grade {
    font-size: 12px;
    font-weight: 700;
    padding: 1px 8px;
    border-radius: 10px;
}

.cm-grade.grade-ë‚®ìŒ { background: #d4edda; color: #155724; }
.cm-grade.grade-ë³´í†µ { background: #fff3cd; color: #856404; }
.cm-grade.grade-ë†’ìŒ { background: #f8d7da; color: #721c24; }
.cm-grade.grade-ë§¤ìš°ë†’ìŒ { background: #c0392b; color: #fff; }

.cm-bar {
    height: 6px;
    background: #e9ecef;
    border-radius: 3px;
    overflow: hidden;
}

.cm-fill {
    height: 100%;
    border-radius: 3px;
    background: linear-gradient(90deg, #27ae60 0%, #f39c12 50%, #e74c3c 100%);
    transition: width 0.6s ease;
}

/* í˜•ìƒ ê¸°ë°˜ ë‹¨ê°€ ë¯¸ë¦¬ë³´ê¸° */
.shape-price-preview {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 12px;
    background: #fff;
    border: 1.5px solid #F4B900;
    border-radius: 8px;
}

.spp-label {
    font-size: 13px;
    color: #666;
}

.spp-value {
    font-size: 16px;
    font-weight: 700;
    color: #F4B900;
}

/* ê²°ê³¼ ì¹´ë“œ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° */
.result-preview-wrap {
    margin-bottom: 16px;
    border-radius: 8px;
    overflow: hidden;
    background:
        linear-gradient(45deg, #e0e0e0 25%, transparent 25%),
        linear-gradient(-45deg, #e0e0e0 25%, transparent 25%),
        linear-gradient(45deg, transparent 75%, #e0e0e0 75%),
        linear-gradient(-45deg, transparent 75%, #e0e0e0 75%);
    background-size: 12px 12px;
    background-position: 0 0, 0 6px, 6px -6px, -6px 0;
    text-align: center;
    max-height: 200px;
}

.result-preview-wrap img {
    max-width: 100%;
    max-height: 200px;
    object-fit: contain;
}

/* ì•„ì›ƒë¼ì¸ ë¯¸ë¦¬ë³´ê¸° */
.outline-preview {
    position: relative;
    background: #1a1a1a !important;
}

.outline-label {
    text-align: center;
    padding: 6px 0;
    font-size: 12px;
    font-weight: 600;
    color: #e74c3c;
    background: rgba(0,0,0,0.7);
}

/* 2ê²¹ ë¼ì¸ ë¯¸ë¦¬ë³´ê¸° (ì¬ë‹¨+ì¸ì‡„) */
.cutting-preview {
    position: relative;
    background: #1a1a1a !important;
}

.cutting-legend {
    display: flex;
    justify-content: center;
    gap: 16px;
    padding: 8px 12px;
    background: rgba(0,0,0,0.8);
    font-size: 12px;
    font-weight: 600;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 4px;
}

.legend-item::before {
    content: '';
    display: inline-block;
    width: 14px;
    height: 3px;
    border-radius: 1px;
}

.legend-print { color: #ff4444; }
.legend-print::before { background: #ff0000; }

.legend-cutting { color: #ccc; }
.legend-cutting::before { background: #000; border: 1px solid #666; }

.legend-hole { color: #4CAF50; }
.legend-hole::before { background: #00b400; border-radius: 50%; width: 8px; height: 8px; }

.result-preview-noimage {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: 16px;
    margin-bottom: 16px;
    background: #f5f5f5;
    border: 1px dashed #ccc;
    border-radius: 8px;
    color: #888;
    font-size: 13px;
}

.result-preview-noimage span {
    font-weight: 600;
    color: #666;
}

/* ì§ì ‘ ì˜ì—­ ì„ íƒ */
.manual-select-trigger {
    margin-top: 12px;
    text-align: center;
}

.btn-manual-select {
    display: inline-block;
    padding: 10px 20px;
    background: #fff;
    border: 1.5px dashed #F4B900;
    border-radius: 8px;
    color: #856404;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    width: 100%;
}

.btn-manual-select:hover {
    background: #fffdf5;
    border-style: solid;
}

/* ìº”ë²„ìŠ¤ ì»¨í…Œì´ë„ˆ */
.manual-canvas-container {
    margin-top: 12px;
    padding: 16px;
    background: #f8f9fa;
    border: 1.5px solid #dee2e6;
    border-radius: 10px;
}

.canvas-title {
    font-size: 14px;
    color: #495057;
    margin-bottom: 10px;
    text-align: center;
}

.canvas-mode-tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 10px;
    background: #e9ecef;
    border-radius: 6px;
    padding: 3px;
}

.mode-tab {
    flex: 1;
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    background: transparent;
    font-size: 13px;
    font-weight: 500;
    color: #6c757d;
    cursor: pointer;
    transition: all 0.2s;
}

.mode-tab.active {
    background: #fff;
    color: #333;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.canvas-wrap {
    border: 1px solid #ced4da;
    border-radius: 6px;
    overflow: hidden;
    background: #fff;
    text-align: center;
}

.canvas-wrap canvas {
    display: block;
    max-width: 100%;
    cursor: crosshair;
    touch-action: none;
}

.canvas-help {
    font-size: 12px;
    color: #888;
    text-align: center;
    margin: 8px 0;
}

.canvas-controls-top {
    display: flex;
    gap: 6px;
    margin-bottom: 6px;
    justify-content: flex-end;
}

.btn-canvas-sm {
    padding: 4px 10px !important;
    font-size: 12px !important;
    flex: none !important;
    min-width: auto !important;
}

.canvas-controls {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
}

.btn-canvas {
    flex: 1;
    min-width: 0;
    padding: 8px 6px;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    background: #fff;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
}

.btn-canvas:hover {
    background: #f8f9fa;
}

.btn-canvas-primary {
    background: #F4B900;
    border-color: #F4B900;
    color: #fff;
    font-weight: 600;
}

.btn-canvas-primary:hover {
    background: #d9a400;
}

.btn-canvas-cancel {
    color: #dc3545;
    border-color: #dc3545;
}

.btn-canvas-cancel:hover {
    background: #fff5f5;
}
</style>

<script src="/static/js/polygon-drawer.js"></script>
<script>
var polygonDrawer = null;

function showManualSelector() {
    var trigger = document.getElementById('manual-select-trigger');
    var container = document.getElementById('manual-canvas-container');
    if (!trigger || !container) return;

    trigger.style.display = 'none';
    container.style.display = 'block';

    // ì˜ì—­ ì„ íƒ ì¤‘ì—ëŠ” ë‹¨ê°€ ê³„ì‚° ë²„íŠ¼ ë¹„í™œì„±í™”
    var calcBtn = document.getElementById('btn-calculate');
    if (calcBtn) {
        calcBtn.disabled = true;
        calcBtn.dataset.blockedByManual = 'true';
    }

    // ìº”ë²„ìŠ¤ì—ëŠ” í•­ìƒ ì›ë³¸ ì´ë¯¸ì§€ ì‚¬ìš© (ë°°ê²½ ìˆëŠ” ìƒíƒœì—ì„œ ì˜ì—­ ì„ íƒ)
    var imgSrc = '{{ file_path }}';
    var canvas = document.getElementById('polygon-canvas');

    if (polygonDrawer) polygonDrawer.destroy();
    polygonDrawer = new PolygonDrawer(canvas, imgSrc, null);
}

function hideManualSelector() {
    var trigger = document.getElementById('manual-select-trigger');
    var container = document.getElementById('manual-canvas-container');
    if (trigger) trigger.style.display = '';
    if (container) container.style.display = 'none';

    // ë‹¨ê°€ ê³„ì‚° ë²„íŠ¼ ë³µì›
    var calcBtn = document.getElementById('btn-calculate');
    if (calcBtn && calcBtn.dataset.blockedByManual === 'true') {
        calcBtn.disabled = false;
        delete calcBtn.dataset.blockedByManual;
    }

    if (polygonDrawer) {
        polygonDrawer.destroy();
        polygonDrawer = null;
    }
}

function switchMode(btn, mode) {
    // íƒ­ í™œì„±í™”
    var tabs = btn.parentElement.querySelectorAll('.mode-tab');
    tabs.forEach(function(t) { t.classList.remove('active'); });
    btn.classList.add('active');

    // ë„ì›€ë§ í…ìŠ¤íŠ¸ ë³€ê²½
    var helpEl = document.getElementById('canvas-help-text');
    if (mode === 'polygon') {
        helpEl.textContent = 'í´ë¦­ìœ¼ë¡œ ê¼­ì§“ì ì„ ì¶”ê°€í•˜ì„¸ìš”. ì²« ì  ê·¼ì²˜ë¥¼ í´ë¦­í•˜ë©´ ìë™ìœ¼ë¡œ ë‹«í™ë‹ˆë‹¤.';
    } else {
        helpEl.textContent = 'ë“œë˜ê·¸ë¡œ ê·¸ë¦¬ì„¸ìš”. ì—¬ëŸ¬ ë²ˆ ë‚˜ëˆ  ê·¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì™„ë£Œ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ìë™ìœ¼ë¡œ ë‹«í™ë‹ˆë‹¤.';
    }

    if (polygonDrawer) polygonDrawer.setMode(mode);
}

function submitManualMask() {
    if (!polygonDrawer) return;

    // í”„ë¦¬í•¸ë“œ ëª¨ë“œ: ì•„ì§ ë‹«íˆì§€ ì•Šì•˜ìœ¼ë©´ ìë™ìœ¼ë¡œ ë‹«ê¸°
    if (polygonDrawer.mode === 'freehand' && !polygonDrawer.isClosed) {
        polygonDrawer.close();
    }

    var points = polygonDrawer.getImagePoints();
    if (!points) {
        alert(polygonDrawer.mode === 'polygon'
            ? 'ì˜ì—­ì„ ì™„ì„±í•´ì£¼ì„¸ìš”. ì²« ì (ë¹¨ê°„ ì ) ê·¼ì²˜ë¥¼ í´ë¦­í•˜ë©´ ë‹«í™ë‹ˆë‹¤.'
            : 'ì˜ì—­ì„ ê·¸ë ¤ì£¼ì„¸ìš”. ë§ˆìš°ìŠ¤/ì†ê°€ë½ìœ¼ë¡œ ë“œë˜ê·¸í•˜ì—¬ ê·¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
    }

    // í˜„ì¬ target í¬ê¸° ê°€ì ¸ì˜¤ê¸°
    var targetW = parseFloat(document.getElementById('width').value) || 100;
    var targetH = parseFloat(document.getElementById('height').value) || 100;

    var polygonJson = JSON.stringify(points);

    // í´ë¦¬ê³¤ ë°ì´í„°ë¥¼ ì „ì—­ì— ì €ì¥ (ë‹¨ê°€ ê³„ì‚°ì—ì„œ ì‚¬ìš©)
    window.manualPolygon = polygonJson;

    var formData = new FormData();
    formData.append('file_path', '{{ file_path }}');
    formData.append('polygon', polygonJson);
    formData.append('target_width', targetW);
    formData.append('target_height', targetH);

    // ë¡œë”© í‘œì‹œ
    var container = document.getElementById('manual-canvas-container');
    container.innerHTML = '<div style="text-align:center;padding:20px;"><div class="spinner"></div><p style="margin-top:8px;color:#666;font-size:13px;">ì˜ì—­ ë¶„ì„ ì¤‘...</p></div>';

    fetch('/api/image/manual-mask', {
        method: 'POST',
        body: formData,
    })
    .then(function(res) { return res.text(); })
    .then(function(html) {
        var resultEl = document.getElementById('image-result');
        if (resultEl) {
            resultEl.innerHTML = html;
            // innerHTMLë¡œ ì‚½ì…ëœ <script>ëŠ” ìë™ ì‹¤í–‰ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ ìˆ˜ë™ ì‹¤í–‰
            var scripts = resultEl.querySelectorAll('script');
            scripts.forEach(function(oldScript) {
                var newScript = document.createElement('script');
                newScript.textContent = oldScript.textContent;
                oldScript.parentNode.replaceChild(newScript, oldScript);
            });
            // ìˆ˜ë™ ì„ íƒ ì™„ë£Œ â†’ ê³„ì‚° ë²„íŠ¼ í™œì„±í™” + blockedByManual í•´ì œ
            var calcBtn = document.getElementById('btn-calculate');
            if (calcBtn) {
                calcBtn.disabled = false;
                delete calcBtn.dataset.blockedByManual;
            }
            if (typeof enableCalculateButton === 'function') {
                enableCalculateButton();
            }
        }
    })
    .catch(function(err) {
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
        hideManualSelector();
    });
}
</script>
