{% set max_width = 406 %}
{% set max_height = 609 %}
{% set too_large = (result.target_width|int > max_width) or (result.target_height|int > max_height) %}

{% if too_large %}
<div class="ratio-result-card ratio-error">
    <h3>âŒ ì œì‘ ë¶ˆê°€ í¬ê¸°</h3>

    <div class="info-badge error">
        <span class="badge-icon">ğŸš«</span>
        <span>ì´ë¯¸ì§€ í¬ê¸°ê°€ ì œì‘ ê°€ëŠ¥ ë²”ìœ„ë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤. ë‹¤ë¥¸ íŒŒì¼ì„ ì²¨ë¶€í•˜ê±°ë‚˜ í¬ê¸°ë¥¼ ì§€ì •í•´ì£¼ì„¸ìš”.</span>
    </div>

    <div class="ratio-info">
        <div class="ratio-item">
            <span class="label">{% if is_transparent %}ì‹¤ì œ ê°ì²´ í¬ê¸°:{% else %}ì›ë³¸ í¬ê¸°:{% endif %}</span>
            <span class="value">{{ result.original_width|int }} Ã— {{ result.original_height|int }} px</span>
        </div>
        <div class="ratio-item highlight-box error-box">
            <span class="label">ê³„ì‚°ëœ í¬ê¸°:</span>
            <span class="value"><strong>{{ result.target_width|int }}mm Ã— {{ result.target_height|int }}mm</strong></span>
        </div>
        <div class="ratio-item">
            <span class="label">ìµœëŒ€ ì œì‘ í¬ê¸°:</span>
            <span class="value">{{ max_width }}mm Ã— {{ max_height }}mm</span>
        </div>
    </div>

    <p class="hint">ê¸°ì¤€ ë°©í–¥ì„ ì„ íƒí•˜ê³  ì›í•˜ëŠ” í¬ê¸°ë¥¼ ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜, ë” ì‘ì€ ì´ë¯¸ì§€ë¥¼ ì²¨ë¶€í•´ì£¼ì„¸ìš”.</p>
</div>

{% else %}
<div class="ratio-result-card">
    <h3>âœ… ë¹„ìœ¨ ê³„ì‚° ì™„ë£Œ</h3>

    {% if is_transparent %}
    <div class="info-badge">
        <span class="badge-icon">ğŸ¯</span>
        <span>íˆ¬ëª… ë°°ê²½ ì œì™¸í•œ ì‹¤ì œ ê°ì²´ í¬ê¸°ë¡œ ê³„ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤</span>
    </div>
    {% else %}
    <div class="info-badge warning">
        <span class="badge-icon">âš ï¸</span>
        <span>ì „ì²´ ì´ë¯¸ì§€ í¬ê¸°ë¡œ ê³„ì‚°ë¨ (PNG íˆ¬ëª… ë°°ê²½ ê¶Œì¥)</span>
    </div>
    {% endif %}

    <div class="ratio-info">
        <div class="ratio-item">
            <span class="label">{% if is_transparent %}ì‹¤ì œ ê°ì²´ í¬ê¸°:{% else %}ì›ë³¸ í¬ê¸°:{% endif %}</span>
            <span class="value">{{ result.original_width|int }} Ã— {{ result.original_height|int }} px</span>
        </div>
        <div class="ratio-item">
            <span class="label">ë¹„ìœ¨:</span>
            <span class="value">{{ result.ratio }}</span>
        </div>
        <div class="ratio-item highlight-box">
            <span class="label">{% if result.target_dimension == 'auto' %}ì´ë¯¸ì§€ ê¸°ì¤€ í¬ê¸°:{% else %}ê³„ì‚°ëœ í¬ê¸° ({% if result.target_dimension == 'height' %}ì„¸ë¡œ{% else %}ê°€ë¡œ{% endif %} ê¸°ì¤€):{% endif %}</span>
            <span class="value"><strong>{{ result.target_width|int }}mm Ã— {{ result.target_height|int }}mm</strong></span>
        </div>
    </div>

    {% if shape_analysis %}
    <!-- í˜•ìƒ ë¶„ì„ ê²°ê³¼ -->
    <div class="shape-analysis-section">
        <h4>ğŸ”¬ AI í˜•ìƒ ë¶„ì„</h4>
        <div class="shape-metrics-mini">
            <div class="sm-row">
                <span class="sm-label">ì•„ì›ƒë¼ì¸ ê¸¸ì´</span>
                <span class="sm-value">{{ "{:,.1f}".format(shape_analysis.perimeter_mm) }} mm</span>
            </div>
            <div class="sm-row">
                <span class="sm-label">ì‹¤ì œ ë©´ì </span>
                <span class="sm-value">{{ "{:,.1f}".format(shape_analysis.area_mm2) }} mmÂ²</span>
            </div>
            <div class="sm-row">
                <span class="sm-label">ì±„ì›€ë¥ </span>
                <span class="sm-value">{{ shape_analysis.fill_pct }}%</span>
            </div>
        </div>

        <!-- ë³µì¡ë„ ë¯¸ë‹ˆ ê²Œì´ì§€ -->
        <div class="complexity-mini">
            <div class="cm-header">
                <span>ë³µì¡ë„</span>
                <span class="cm-grade grade-{{ shape_analysis.complexity_label }}">{{ shape_analysis.complexity_label }}</span>
            </div>
            <div class="cm-bar">
                <div class="cm-fill" style="width: {{ shape_analysis.complexity_pct|int }}%"></div>
            </div>
        </div>

        <div class="shape-price-preview">
            <span class="spp-label">í˜•ìƒ ê¸°ë°˜ ë‹¨ê°€ (ì˜ˆìƒ)</span>
            <span class="spp-value">{{ "{:,}".format(shape_analysis.unit_price) }}ì›</span>
        </div>
    </div>
    {% endif %}

    <p class="hint">ì´ í¬ê¸°ê°€ ìë™ìœ¼ë¡œ ë‹¨ê°€ ê³„ì‚°ì— ì ìš©ë©ë‹ˆë‹¤</p>

    <!-- ìˆ¨ê²¨ì§„ inputìœ¼ë¡œ ê³„ì‚° í¼ì— ì „ë‹¬ -->
    <script>
        document.getElementById('width').value = {{ result.target_width }};
        document.getElementById('height').value = {{ result.target_height }};
        // ë¹„ìœ¨ ê³„ì‚°ìœ¼ë¡œ ì ìš©ëœ í¬ê¸°ëŠ” ìˆ˜ì • ë¶ˆê°€
        document.getElementById('width').readOnly = true;
        document.getElementById('height').readOnly = true;
        document.getElementById('width').classList.add('readonly-field');
        document.getElementById('height').classList.add('readonly-field');
        window.ratioLocked = true;
        // ë¹„ìœ¨ ê³„ì‚°ì—ì„œ ì—…ë¡œë“œí•œ íŒŒì¼ ê²½ë¡œ ì €ì¥
        window.ratioFilePath = '{{ file_path }}';
        // í˜•ìƒ ë¶„ì„ ì—¬ë¶€ ì €ì¥
        window.shapeAnalysisAvailable = {{ 'true' if shape_analysis else 'false' }};
        // ì£¼ë¬¸ í¼ hidden inputì— ì§ì ‘ ì„¸íŒ…
        var ratioFileInput = document.getElementById('order_ratio_file');
        if (ratioFileInput) ratioFileInput.value = '{{ file_path }}';
        // ìë™ ì²¨ë¶€ í‘œì‹œ
        var autoAttached = document.getElementById('auto-attached-file');
        var autoName = document.getElementById('auto-attached-name');
        if (autoAttached && autoName) {
            autoName.textContent = '{{ filename }}';
            autoAttached.style.display = 'flex';
            document.getElementById('design_file').style.display = 'none';
            document.getElementById('design_file_hint').style.display = 'none';
        }
        // í˜•ìƒ ë¶„ì„ì´ ìˆìœ¼ë©´ ê³„ì‚° ë²„íŠ¼ í™œì„±í™”
        if (window.shapeAnalysisAvailable) {
            enableCalculateButton();
        }
        // ê³„ì‚° íŠ¸ë¦¬ê±°
        document.querySelector('.calculator-form').dispatchEvent(new Event('submit'));
    </script>
</div>
{% endif %}

<style>
.ratio-result-card {
    background: #fffdf5;
    border: 2px solid #F4B900;
    border-radius: 12px;
    padding: 20px;
    margin-top: 16px;
}

.ratio-result-card.ratio-error {
    background: #fff5f5;
    border-color: #ff4444;
}

.ratio-result-card h3 {
    color: #5C5C5C;
    margin-bottom: 16px;
    font-size: 16px;
}

.ratio-info {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.ratio-item {
    display: flex;
    justify-content: space-between;
    padding: 8px;
}

.ratio-item .label {
    color: #666;
}

.ratio-item .value {
    font-weight: 600;
    color: #333;
}

.highlight-box {
    background: #fff;
    border-radius: 8px;
    padding: 12px !important;
}

.highlight-box .value strong {
    color: #F4B900;
    font-size: 18px;
}

.error-box {
    background: #ffe0e0;
}

.error-box .value strong {
    color: #ff4444;
}

.hint {
    margin-top: 12px;
    font-size: 13px;
    color: #666;
    text-align: center;
}

.info-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px;
    background: #d4edda;
    border: 1px solid #c3e6cb;
    border-radius: 8px;
    margin-bottom: 16px;
    font-size: 13px;
    color: #155724;
}

.info-badge.warning {
    background: #fff3cd;
    border-color: #ffeaa7;
    color: #856404;
}

.info-badge.error {
    background: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
}

.badge-icon {
    font-size: 18px;
}

/* í˜•ìƒ ë¶„ì„ ì„¹ì…˜ */
.shape-analysis-section {
    margin-top: 16px;
    padding: 16px;
    background: #f0f7ff;
    border: 1px solid #b8d4f0;
    border-radius: 10px;
}

.shape-analysis-section h4 {
    font-size: 14px;
    color: #2c5282;
    margin-bottom: 12px;
}

.shape-metrics-mini {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-bottom: 12px;
}

.sm-row {
    display: flex;
    justify-content: space-between;
    font-size: 13px;
    padding: 4px 8px;
}

.sm-label {
    color: #4a6fa5;
}

.sm-value {
    font-weight: 600;
    color: #2c5282;
}

/* ë³µì¡ë„ ë¯¸ë‹ˆ ê²Œì´ì§€ */
.complexity-mini {
    margin-bottom: 12px;
    padding: 8px;
    background: #fff;
    border-radius: 6px;
}

.cm-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 13px;
    color: #555;
    margin-bottom: 6px;
}

.cm-grade {
    font-size: 12px;
    font-weight: 700;
    padding: 1px 8px;
    border-radius: 10px;
}

.cm-grade.grade-ë‚®ìŒ { background: #d4edda; color: #155724; }
.cm-grade.grade-ë³´í†µ { background: #fff3cd; color: #856404; }
.cm-grade.grade-ë†’ìŒ { background: #f8d7da; color: #721c24; }
.cm-grade.grade-ë§¤ìš°ë†’ìŒ { background: #c0392b; color: #fff; }

.cm-bar {
    height: 6px;
    background: #e9ecef;
    border-radius: 3px;
    overflow: hidden;
}

.cm-fill {
    height: 100%;
    border-radius: 3px;
    background: linear-gradient(90deg, #27ae60 0%, #f39c12 50%, #e74c3c 100%);
    transition: width 0.6s ease;
}

/* í˜•ìƒ ê¸°ë°˜ ë‹¨ê°€ ë¯¸ë¦¬ë³´ê¸° */
.shape-price-preview {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 12px;
    background: #fff;
    border: 1.5px solid #F4B900;
    border-radius: 8px;
}

.spp-label {
    font-size: 13px;
    color: #666;
}

.spp-value {
    font-size: 16px;
    font-weight: 700;
    color: #F4B900;
}
</style>
