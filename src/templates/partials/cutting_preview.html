<script>
if (typeof openPreviewZoom === 'undefined') {
    function openPreviewZoom(imgEl) {
        var existing = document.querySelector('.preview-zoom-overlay');
        if (existing) existing.remove();
        var overlay = document.createElement('div');
        overlay.className = 'preview-zoom-overlay';
        overlay.onclick = function() { overlay.remove(); };
        var closeBtn = document.createElement('span');
        closeBtn.className = 'preview-zoom-close';
        closeBtn.textContent = '\u00d7';
        var zoomImg = document.createElement('img');
        zoomImg.src = imgEl.src;
        zoomImg.alt = imgEl.alt;
        var hint = document.createElement('span');
        hint.className = 'preview-zoom-hint';
        hint.textContent = '\ud0ed\ud558\uc5ec \ub2eb\uae30';
        overlay.appendChild(closeBtn);
        overlay.appendChild(zoomImg);
        overlay.appendChild(hint);
        document.body.appendChild(overlay);
    }
}
</script>
<!-- 재단/인쇄 라인 미리보기 (키링 옵션 변경 시 부분 교체) -->
{% if cutting_preview_path %}
<div class="result-preview-wrap cutting-preview">
    <img src="{{ cutting_preview_path }}?t={{ range(100000,999999)|random }}" alt="재단 라인 미리보기" onclick="openPreviewZoom(this)" style="cursor:zoom-in;">
    <div class="cutting-legend">
        <span class="legend-item legend-cutting" style="color:#e60000;">빨간 라인 = 재단(커팅) 라인</span>
    </div>
</div>
<p class="preview-notice" style="font-size:13px;color:#c0392b;text-align:center;margin:8px 0 12px;line-height:1.6;padding:10px 14px;background:#fff5f5;border:1.5px solid #e74c3c;border-radius:8px;">견적을 위한 임시 파일입니다. 실제 시안과 다를 수 있습니다. 시안 확인을 원하시면 주문 시 <strong style="color:#c0392b;font-weight:700;text-decoration:underline;">시안 확인하기</strong>를 체크해 주세요.</p>
{% endif %}

{% if shape_analysis %}
<div class="shape-analysis-section">
    <h4>AI 형상 분석 (재단 라인 기준)</h4>
    <div class="shape-metrics-mini">
        <div class="sm-row">
            <span class="sm-label">재단 아웃라인 길이</span>
            <span class="sm-value">{{ "{:,.1f}".format(shape_analysis.cutting_perimeter_mm|default(shape_analysis.perimeter_mm)) }} mm</span>
        </div>
        <div class="sm-row">
            <span class="sm-label">재단 면적</span>
            <span class="sm-value">{{ "{:,.1f}".format(shape_analysis.cutting_area_mm2|default(shape_analysis.area_mm2)) }} mm2</span>
        </div>
        <div class="sm-row">
            <span class="sm-label">채움률</span>
            <span class="sm-value">{{ shape_analysis.fill_pct }}%</span>
        </div>
    </div>

    <div class="complexity-mini">
        <div class="cm-header">
            <span>복잡도</span>
            <span class="cm-grade grade-{{ shape_analysis.complexity_label|replace(' ', '-') }}">{{ shape_analysis.complexity_label }}</span>
        </div>
        <div class="cm-sub-scores">
            <div class="cm-sub-row">
                <span class="cm-sub-label">아웃라인</span>
                <div class="cm-sub-bar"><div class="cm-sub-fill cm-sub-outline" style="width:{{ shape_analysis.outline_length_pct|default(0)|int }}%"></div></div>
                <span class="cm-sub-pct">{{ shape_analysis.outline_length_pct|default(0)|int }}%</span>
            </div>
            <div class="cm-sub-row">
                <span class="cm-sub-label">방향전환</span>
                <div class="cm-sub-bar"><div class="cm-sub-fill cm-sub-direction" style="width:{{ shape_analysis.direction_change_pct|default(0)|int }}%"></div></div>
                <span class="cm-sub-pct">{{ shape_analysis.direction_change_pct|default(0)|int }}%</span>
            </div>
        </div>
        <div class="cm-bar">
            <div class="cm-fill" style="width: {{ shape_analysis.complexity_pct|int }}%"></div>
        </div>
    </div>

    <div class="shape-price-preview">
        <span class="spp-label">형상 기반 단가 (예상)</span>
        <span class="spp-value">{{ "{:,}".format(shape_analysis.unit_price) }}원</span>
    </div>
</div>
{% endif %}
