{% extends "base.html" %}

{% block content %}
<div class="calculator-card">
    <div class="header-section">
        <img src="/static/images/logo.png" alt="ì„œë¸”ë¦¬ì› ë¡œê³ " class="logo">
        <div class="title-group">
            <h1>ì„œë¸”ë¦¬ì› ì•„í¬ë¦´ ì£¼ë¬¸ì œì‘ ì‹ ì²­ì‹œíŠ¸</h1>
        </div>
    </div>

    <!-- ì´ë¯¸ì§€ ë¹„ìœ¨ ê³„ì‚°ê¸° -->
    <div class="section-divider section-with-reset">
        <div>
            <h2>ğŸ“ ì´ë¯¸ì§€ ë¹„ìœ¨ ê³„ì‚° (ì„ íƒ)</h2>
            <p class="section-desc">ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ë©´ ì›í•˜ëŠ” ê°€ë¡œ í¬ê¸°ì— ë§ì¶° ì„¸ë¡œë¥¼ ìë™ ê³„ì‚°í•©ë‹ˆë‹¤</p>
        </div>
        <button type="button" onclick="resetRatio()" class="btn-section-reset">ì´ˆê¸°í™”</button>
    </div>

    <p class="file-format-hint"><strong>PNG(ì¶”ì²œ)</strong>: íˆ¬ëª… ë°°ê²½ ì œì™¸, ì‹¤ì œ ì´ë¯¸ì§€ë§Œ ê³„ì‚° / <strong>JPG</strong>: ë°°ê²½ í¬í•¨ ì „ì²´ í¬ê¸°ë¡œ ê³„ì‚°</p>

    <div class="skip-ratio-toggle">
        <label class="checkbox-label">
            <input type="checkbox" id="skip-ratio" onchange="toggleRatioMode()">
            <span>ë¹„ìœ¨ ê³„ì‚° ì—†ì´ ì§ì ‘ ì…ë ¥</span>
        </label>
        <small class="skip-ratio-hint">ì²´í¬í•˜ë©´ ì•„ë˜ì—ì„œ ê°€ë¡œ/ì„¸ë¡œë¥¼ ì§ì ‘ ì…ë ¥í•©ë‹ˆë‹¤</small>
    </div>

    <div id="ratio-calc-section">
        <form
            hx-post="/api/image/upload"
            hx-target="#image-result"
            hx-encoding="multipart/form-data"
            class="image-form"
        >
            <div class="form-row">
                <div class="form-group flex-2">
                    <label for="image">ì´ë¯¸ì§€ íŒŒì¼</label>
                    <input
                        type="file"
                        id="image"
                        name="file"
                        accept="image/*,.ai,.psd"
                        class="file-input"
                    >
                </div>
                <div class="form-group flex-1">
                    <label for="target_dimension">ê¸°ì¤€ ë°©í–¥</label>
                    <select id="target_dimension" name="target_dimension" class="select-input">
                        <option value="width">ê°€ë¡œ ê¸°ì¤€</option>
                        <option value="height">ì„¸ë¡œ ê¸°ì¤€</option>
                    </select>
                </div>
                <div class="form-group flex-1">
                    <label for="target_size" id="target_size_label">ì›í•˜ëŠ” ê°€ë¡œ (mm)</label>
                    <input
                        type="number"
                        id="target_size"
                        name="target_size"
                        step="0.1"
                        min="1"
                        placeholder="ì˜ˆ: 100"
                    >
                </div>
            </div>
            <button type="submit" class="btn-secondary">ë¹„ìœ¨ ê³„ì‚°</button>
        </form>
    </div>


    <div id="image-result"></div>

    <!-- ë‹¨ê°€ ê³„ì‚°ê¸° -->
    <div class="section-divider section-with-reset">
        <h2>ğŸ’° ë‹¨ê°€ ê³„ì‚°</h2>
        <button type="button" onclick="resetCalc()" class="btn-section-reset">ì´ˆê¸°í™”</button>
    </div>

    <form
        hx-post="/api/calculate"
        hx-target="#result"
        hx-swap="innerHTML"
        hx-trigger="submit, change delay:500ms from:input"
        class="calculator-form"
    >
        <div class="form-row">
            <div class="form-group">
                <label for="width">ê°€ë¡œ (mm)</label>
                <input
                    type="number"
                    id="width"
                    name="width"
                    step="0.1"
                    min="1"
                    max="600"
                    required
                    placeholder="ì˜ˆ: 50.0"
                >
            </div>

            <div class="form-group">
                <label for="height">ì„¸ë¡œ (mm)</label>
                <input
                    type="number"
                    id="height"
                    name="height"
                    step="0.1"
                    min="1"
                    max="600"
                    required
                    placeholder="ì˜ˆ: 100.0"
                >
            </div>

            <div class="form-group">
                <label for="quantity">ì£¼ë¬¸ ìˆ˜ëŸ‰ (ê°œ)</label>
                <input
                    type="number"
                    id="quantity"
                    name="quantity"
                    min="1"
                    required
                    placeholder="ì˜ˆ: 50"
                >
            </div>
        </div>

        <button type="submit" class="btn-calculate">ê³„ì‚°í•˜ê¸°</button>
    </form>

    <div id="result" class="result-area">
        <p class="placeholder">ìœ„ ì •ë³´ë¥¼ ì…ë ¥í•˜ì‹œë©´ ìë™ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.</p>
    </div>

    <!-- ì£¼ë¬¸ ì‹ ì²­ í¼ -->
    <div id="order-section" class="order-section" style="display: none;">
        <div class="section-divider section-with-reset">
            <div>
                <h2>ğŸ“ ì£¼ë¬¸ ì‹ ì²­</h2>
                <p class="section-desc">ê³„ì‚° ê²°ê³¼ê°€ ë§ë‹¤ë©´ ì•„ë˜ ì •ë³´ë¥¼ ì…ë ¥í•˜ì—¬ ì£¼ë¬¸ì„ ì‹ ì²­í•˜ì„¸ìš”</p>
            </div>
            <button type="button" onclick="resetOrder()" class="btn-section-reset">ì´ˆê¸°í™”</button>
        </div>

        <form
            hx-post="/api/order/submit"
            hx-target="#order-result"
            hx-encoding="multipart/form-data"
            class="order-form"
        >
            <input type="hidden" id="order_width" name="width">
            <input type="hidden" id="order_height" name="height">
            <input type="hidden" id="order_quantity" name="quantity">

            <div class="form-row">
                <div class="form-group">
                    <label for="customer_name">ì´ë¦„ *</label>
                    <input
                        type="text"
                        id="customer_name"
                        name="customer_name"
                        required
                        placeholder="í™ê¸¸ë™"
                    >
                </div>

                <div class="form-group">
                    <label for="customer_phone">ì—°ë½ì²˜ *</label>
                    <input
                        type="tel"
                        id="customer_phone"
                        name="customer_phone"
                        required
                        placeholder="010-1234-5678"
                    >
                </div>
            </div>

            <div class="form-group">
                <label for="customer_email">ì´ë©”ì¼ *</label>
                <input
                    type="email"
                    id="customer_email"
                    name="customer_email"
                    required
                    placeholder="example@email.com"
                >
            </div>

            <div class="form-group">
                <label for="design_file" id="design_file_label">ë””ìì¸ íŒŒì¼ (ì„ íƒ)</label>
                <input
                    type="file"
                    id="design_file"
                    name="file"
                    class="file-input"
                    accept="image/*,.ai,.psd,.pdf"
                >
                <small id="design_file_hint">AI, PSD, PNG, JPG, PDF ë“± ë””ìì¸ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</small>
            </div>

            <label class="option-checkbox">
                <input type="checkbox" id="opt_template_file" name="template_file" value="1" onchange="updateOrderTotal()">
                <span class="option-text">
                    <strong>ì‘ì—…í‹€ íŒŒì¼ ì œì‘ (AI/PSD)</strong>
                    <small>ì£¼ë¬¸ ì œì‘ìš© ì‘ì—…í‹€ íŒŒì¼ì´ í•„ìš”í•œ ê²½ìš° (+10,000ì›, VATë³„ë„)</small>
                </span>
            </label>

            <div class="order-price-summary">
                <div class="order-price-row">
                    <span>ì œì‘ë¹„ (VATë³„ë„)</span>
                    <span id="order-base-price">0ì›</span>
                </div>
                <div class="order-price-row" id="order-template-row" style="display:none;">
                    <span>ì‘ì—…í‹€ ë¹„ìš© (VATë³„ë„)</span>
                    <span>10,000ì›</span>
                </div>
                <div class="order-price-row order-price-subtotal">
                    <span>í•©ê³„ (VATë³„ë„)</span>
                    <strong id="order-subtotal-price">0ì›</strong>
                </div>
                <div class="order-price-row order-price-total">
                    <span>ìµœì¢… ê¸ˆì•¡ (VATí¬í•¨)</span>
                    <strong id="order-final-price">0ì›</strong>
                </div>
            </div>

            <div class="form-group">
                <label for="notes">ìš”ì²­ì‚¬í•­ (ì„ íƒ)</label>
                <textarea
                    id="notes"
                    name="notes"
                    rows="3"
                    placeholder="ì¶”ê°€ë¡œ ìš”ì²­í•˜ì‹¤ ë‚´ìš©ì´ ìˆìœ¼ì‹œë©´ ì…ë ¥í•´ì£¼ì„¸ìš”"
                ></textarea>
            </div>

            <button type="submit" class="btn-order">ì£¼ë¬¸ ì‹ ì²­í•˜ê¸°</button>
        </form>

        <div id="order-result"></div>
    </div>
</div>


<script>
// ë¹„ìœ¨ ê³„ì‚° ì‚¬ìš© ì—¬ë¶€ ì¶”ì 
var ratioUsed = false;

// ê³„ì‚° ê²°ê³¼ê°€ ë‚˜ì˜¤ë©´ ì£¼ë¬¸ í¼ í‘œì‹œ
document.body.addEventListener('htmx:afterSwap', function(event) {
    if (event.detail.target.id === 'result') {
        var orderSection = document.getElementById('order-section');
        if (orderSection) {
            orderSection.style.display = 'block';
            document.getElementById('order_width').value = document.getElementById('width').value;
            document.getElementById('order_height').value = document.getElementById('height').value;
            document.getElementById('order_quantity').value = document.getElementById('quantity').value;
            updateDesignFileRequired();
            updateOrderTotal();
        }
    }
    if (event.detail.target.id === 'image-result') {
        ratioUsed = true;
    }
});

// ê¸°ì¤€ ë°©í–¥ ë³€ê²½ ì‹œ ë¼ë²¨ ì—…ë°ì´íŠ¸
document.getElementById('target_dimension').addEventListener('change', function() {
    var label = document.getElementById('target_size_label');
    label.textContent = this.value === 'width' ? 'ì›í•˜ëŠ” ê°€ë¡œ (mm)' : 'ì›í•˜ëŠ” ì„¸ë¡œ (mm)';
});

// ë¹„ìœ¨ ê³„ì‚° ëª¨ë“œ í† ê¸€
function toggleRatioMode() {
    var skipCheckbox = document.getElementById('skip-ratio');
    var ratioSection = document.getElementById('ratio-calc-section');
    var imageResult = document.getElementById('image-result');

    if (skipCheckbox.checked) {
        ratioSection.style.display = 'none';
        imageResult.innerHTML = '';
        ratioUsed = false;
    } else {
        ratioSection.style.display = 'block';
    }
    updateDesignFileRequired();
}

// ë””ìì¸ íŒŒì¼ í•„ìˆ˜/ì„ íƒ ì—…ë°ì´íŠ¸
function updateDesignFileRequired() {
    var label = document.getElementById('design_file_label');
    var input = document.getElementById('design_file');
    var hint = document.getElementById('design_file_hint');
    var skipChecked = document.getElementById('skip-ratio').checked;

    if (skipChecked || !ratioUsed) {
        label.textContent = 'ë””ìì¸ íŒŒì¼ *';
        input.required = true;
        hint.textContent = 'ë¹„ìœ¨ ê³„ì‚°ì„ í•˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ ë””ìì¸ íŒŒì¼ì„ ì²¨ë¶€í•´ ì£¼ì„¸ìš”';
    } else {
        label.textContent = 'ë””ìì¸ íŒŒì¼ (ì„ íƒ)';
        input.required = false;
        hint.textContent = 'ë¹„ìœ¨ ê³„ì‚° ì‹œ ì²¨ë¶€í•œ íŒŒì¼ì´ ìˆìœ¼ë¯€ë¡œ ì„ íƒì‚¬í•­ì…ë‹ˆë‹¤';
    }
}

// ë¹„ìœ¨ ê³„ì‚° ì„¹ì…˜ ì´ˆê¸°í™”
function resetRatio() {
    var form = document.querySelector('#ratio-calc-section .image-form');
    if (form) form.reset();
    document.getElementById('skip-ratio').checked = false;
    document.getElementById('image-result').innerHTML = '';
    document.getElementById('target_size_label').textContent = 'ì›í•˜ëŠ” ê°€ë¡œ (mm)';
    ratioUsed = false;
    toggleRatioMode();
}

// ë‹¨ê°€ ê³„ì‚° ì„¹ì…˜ ì´ˆê¸°í™”
function resetCalc() {
    document.querySelector('.calculator-form').reset();
    document.getElementById('result').innerHTML = '<p class="placeholder">ìœ„ ì •ë³´ë¥¼ ì…ë ¥í•˜ì‹œë©´ ìë™ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.</p>';
    document.getElementById('order-section').style.display = 'none';
}

// ì£¼ë¬¸ ê¸ˆì•¡ ì—…ë°ì´íŠ¸
function updateOrderTotal() {
    var base = window.calcPrice || 0;
    var templateChecked = document.getElementById('opt_template_file').checked;
    var templateRow = document.getElementById('order-template-row');
    var totalBeforeVat = base + (templateChecked ? 10000 : 0);
    var totalWithVat = Math.floor(totalBeforeVat * 1.1);

    document.getElementById('order-base-price').textContent = base.toLocaleString() + 'ì›';
    templateRow.style.display = templateChecked ? 'flex' : 'none';
    document.getElementById('order-subtotal-price').textContent = totalBeforeVat.toLocaleString() + 'ì›';
    document.getElementById('order-final-price').textContent = totalWithVat.toLocaleString() + 'ì›';
}

// ì£¼ë¬¸ ì‹ ì²­ ì„¹ì…˜ ì´ˆê¸°í™”
function resetOrder() {
    document.querySelector('.order-form').reset();
    document.getElementById('order-result').innerHTML = '';
    updateDesignFileRequired();
    updateOrderTotal();
}
</script>

<style>
.section-with-reset {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.btn-section-reset {
    padding: 6px 14px;
    background: #fff;
    color: #F4B900;
    border: 1.5px solid #F4B900;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
    flex-shrink: 0;
    margin-top: 4px;
}

.btn-section-reset:hover {
    background: #F4B900;
    color: #fff;
}

.section-divider {
    margin: 32px 0 16px 0;
    padding-top: 32px;
    border-top: 2px solid #f0f0f0;
}

.section-divider:first-of-type {
    border-top: none;
    padding-top: 0;
}

.section-divider h2 {
    font-size: 20px;
    color: #333;
    margin-bottom: 8px;
    font-weight: 700;
}

.section-desc {
    font-size: 14px;
    color: #666;
    margin-bottom: 16px;
}

.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
}

.flex-1 {
    flex: 1;
}

.flex-2 {
    flex: 2;
}

.image-form {
    margin-bottom: 16px;
}

.file-input {
    padding: 8px 12px !important;
    border: 2px dashed #e0e0e0 !important;
    background: #f8f9fa;
    cursor: pointer;
}

.file-input:hover {
    border-color: #F4B900 !important;
    background: #fffbf0;
}

.btn-secondary {
    width: 100%;
    padding: 12px;
    background: #f0f0f0;
    color: #333;
    border: none;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-secondary:hover {
    background: #e0e0e0;
}

.order-section {
    animation: fadeIn 0.5s;
}

.order-form textarea {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 16px;
    font-family: inherit;
    resize: vertical;
}

.order-form small {
    display: block;
    margin-top: 6px;
    font-size: 13px;
    color: #666;
}

.btn-order {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, #F4B900 0%, #E5A800 100%);
    color: #1A1A1A;
    border: none;
    border-radius: 8px;
    font-size: 18px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    margin-top: 8px;
}

.btn-order:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(244, 185, 0, 0.6);
}

/* íŒŒì¼ í¬ë§· íŒíŠ¸ (í•œ ì¤„) */
.file-format-hint {
    font-size: 13px;
    color: #666;
    background: #f9f9f9;
    border-left: 3px solid #F4B900;
    padding: 8px 12px;
    margin-bottom: 14px;
    border-radius: 0 6px 6px 0;
    line-height: 1.5;
}

/* select ì…ë ¥ */
.select-input {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 16px;
    background: #fff;
    cursor: pointer;
    appearance: auto;
}

/* ë¹„ìœ¨ ê³„ì‚° ê±´ë„ˆë›°ê¸° í† ê¸€ */
.skip-ratio-toggle {
    margin-bottom: 20px;
    padding: 14px 16px;
    background: #f5f5f5;
    border-radius: 10px;
    border: 1px solid #e0e0e0;
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    font-size: 15px;
    font-weight: 600;
    color: #333;
}

.checkbox-label input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: #F4B900;
}

.skip-ratio-hint {
    display: block;
    margin-top: 8px;
    margin-left: 28px;
    font-size: 13px;
    color: #888;
}

/* ì‘ì—…í‹€ ì˜µì…˜ ì²´í¬ë°•ìŠ¤ */
.option-checkbox {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 14px;
    background: #fff;
    border: 1.5px solid #e0e0e0;
    border-radius: 8px;
    cursor: pointer;
    margin-bottom: 16px;
    transition: all 0.2s;
}

.option-checkbox:hover {
    border-color: #F4B900;
}

.option-checkbox:has(input:checked) {
    border-color: #F4B900;
    background: #fffbf0;
}

.option-checkbox input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: #F4B900;
    flex-shrink: 0;
}

.option-text {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.option-text strong {
    font-size: 14px;
    color: #333;
}

.option-text small {
    font-size: 12px;
    color: #888;
}

/* ì£¼ë¬¸ ê¸ˆì•¡ ìš”ì•½ */
.order-price-summary {
    background: #f9f9f9;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    padding: 16px;
    margin-bottom: 16px;
}

.order-price-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    font-size: 14px;
    color: #666;
}

.order-price-subtotal {
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid #e0e0e0;
    font-size: 14px;
    color: #555;
}

.order-price-subtotal strong {
    font-size: 15px;
    color: #555;
}

.order-price-total {
    margin-top: 6px;
    padding-top: 8px;
    border-top: 2px solid #F4B900;
    font-size: 16px;
    color: #333;
}

.order-price-total strong {
    font-size: 22px;
    color: #F4B900;
}

</style>
{% endblock %}
