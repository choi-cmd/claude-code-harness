{% extends "base.html" %}

{% block content %}
<div class="calculator-card">
    <div class="header-section">
        <img src="/static/images/logo.png" alt="ì„œë¸”ë¦¬ì› ë¡œê³ " class="logo">
        <div class="title-group">
            <h1>ì„œë¸”ë¦¬ì› ì•„í¬ë¦´ ì£¼ë¬¸ì œì‘ í”„ë¡œê·¸ë¨</h1>
        </div>
    </div>
    <hr class="header-divider">

    <div id="calc-area">
    <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ (í•„ìˆ˜) -->
    <div class="section-divider section-with-reset">
        <div>
            <h2>ğŸ“ ì´ë¯¸ì§€ ì—…ë¡œë“œ (í•„ìˆ˜)</h2>
            <p class="section-desc">ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ë©´ í˜•ìƒì„ ë¶„ì„í•˜ì—¬ ì •ë°€ ê²¬ì ì„ ê³„ì‚°í•©ë‹ˆë‹¤</p>
        </div>
        <button type="button" onclick="resetRatio()" class="btn-section-reset">ì´ˆê¸°í™”</button>
    </div>

    <div id="ratio-calc-section">
        <form
            hx-post="/api/image/upload"
            hx-target="#image-result"
            hx-encoding="multipart/form-data"
            class="image-form"
        >
            <div class="auto-size-toggle-wrap">
                <label class="auto-size-toggle">
                    <input type="checkbox" id="auto-size" onchange="toggleAutoSize()">
                    <span>ì²¨ë¶€í•œ ì´ë¯¸ì§€ í¬ê¸° ê·¸ëŒ€ë¡œ ìë™ ê³„ì‚°</span>
                </label>
                <small class="auto-size-hint">ì´ë¯¸ì§€ì˜ í”½ì…€ í¬ê¸°ë¥¼ mm ë‹¨ìœ„ë¡œ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤</small>
            </div>
            <div class="file-format-hint">
                <p><strong>PNG(ì¶”ì²œ)</strong>: íˆ¬ëª… ë°°ê²½ ì œì™¸, ì‹¤ì œ ì´ë¯¸ì§€ë§Œ ê³„ì‚°</p>
                <p><strong>JPG</strong>: ë°°ê²½ ìë™ ë¶„ë¦¬ë¡œ í˜•ìƒ ì¸ì‹ ê°€ëŠ¥</p>
            </div>
            <div class="form-row">
                <div class="form-group flex-2">
                    <label for="image">ì´ë¯¸ì§€ íŒŒì¼</label>
                    <input
                        type="file"
                        id="image"
                        name="file"
                        accept="image/*,.ai,.psd"
                        class="file-input"
                    >
                    <div id="image-preview-container" class="image-preview-container" style="display:none;">
                        <div class="image-preview-wrap">
                            <img id="image-preview" src="" alt="ë¯¸ë¦¬ë³´ê¸°">
                        </div>
                        <div class="image-preview-info">
                            <span id="image-preview-name" class="image-preview-name"></span>
                            <button type="button" onclick="clearImagePreview()" class="btn-preview-remove">âœ•</button>
                        </div>
                    </div>
                </div>
                <div class="form-group flex-1">
                    <label for="target_dimension">ê¸°ì¤€ ë°©í–¥</label>
                    <select id="target_dimension" name="target_dimension" class="select-input" onchange="updateTargetLabel()">
                        <option value="width">ê°€ë¡œ ê¸°ì¤€</option>
                        <option value="height">ì„¸ë¡œ ê¸°ì¤€</option>
                    </select>
                </div>
                <div class="form-group flex-1" id="target_size_group">
                    <label for="target_size" id="target_size_label">ì›í•˜ëŠ” ê°€ë¡œ (mm)</label>
                    <input
                        type="number"
                        id="target_size"
                        name="target_size"
                        step="1"
                        min="1"
                        placeholder="ì˜ˆ: 100"
                    >
                </div>
            </div>
            <button type="submit" class="btn-secondary" id="btn-ratio">
                <span class="btn-ratio-text">ë¹„ìœ¨ ê³„ì‚°</span>
                <span class="btn-ratio-loading" style="display:none;">â³ ì´ë¯¸ì§€ ë¶„ì„ ì¤‘...</span>
            </button>
        </form>
    </div>


    <div id="image-result"></div>

    <!-- ë‹¨ê°€ ê³„ì‚°ê¸° -->
    <div class="section-divider section-with-reset">
        <h2>ğŸ’° ë‹¨ê°€ ê³„ì‚°</h2>
        <button type="button" onclick="resetCalc()" class="btn-section-reset">ì´ˆê¸°í™”</button>
    </div>

    <form
        hx-post="/api/calculate-shape"
        hx-target="#result"
        hx-swap="innerHTML"
        hx-trigger="submit"
        class="calculator-form"
        id="calc-form"
    >
        <input type="hidden" id="shape_file_path" name="file_path" value="">
        <div class="form-row">
            <div class="form-group">
                <label for="width">ê°€ë¡œ (mm)</label>
                <input
                    type="number"
                    id="width"
                    name="width"
                    step="0.1"
                    min="1"
                    max="600"
                    required
                    placeholder="ì˜ˆ: 50.0"
                >
            </div>

            <div class="form-group">
                <label for="height">ì„¸ë¡œ (mm)</label>
                <input
                    type="number"
                    id="height"
                    name="height"
                    step="0.1"
                    min="1"
                    max="600"
                    required
                    placeholder="ì˜ˆ: 100.0"
                >
            </div>

            <div class="form-group">
                <label for="quantity">ì£¼ë¬¸ ìˆ˜ëŸ‰ (ê°œ)</label>
                <input
                    type="number"
                    id="quantity"
                    name="quantity"
                    min="1"
                    required
                    placeholder="ì˜ˆ: 50"
                >
            </div>
        </div>

        <!-- í˜•ìƒ ë¶„ì„ ëª¨ë“œ í‘œì‹œ -->
        <div id="shape-mode-badge" class="shape-mode-badge" style="display:none;">
            <span>ğŸ”¬ í˜•ìƒ ê¸°ë°˜ ê²¬ì  ëª¨ë“œ</span>
            <small>ì´ë¯¸ì§€ ë¶„ì„ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì •ë°€ ê²¬ì ì´ ì ìš©ë©ë‹ˆë‹¤</small>
        </div>

        <div id="image-required-hint" class="image-required-hint">
            <span>ì´ë¯¸ì§€ë¥¼ ë¨¼ì € ì—…ë¡œë“œí•˜ì„¸ìš”</span>
        </div>
        <button type="submit" class="btn-calculate" id="btn-calculate" disabled>ê³„ì‚°í•˜ê¸°</button>
    </form>

    <div id="result" class="result-area">
        <p class="placeholder">ìœ„ ì •ë³´ë¥¼ ì…ë ¥í•˜ì‹œë©´ ìë™ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.</p>
    </div>

    </div><!-- /calc-area -->

    <!-- ì£¼ë¬¸ ì‹ ì²­ í¼ -->
    <div id="order-section" class="order-section" style="display: none;">
        <button type="button" onclick="backToCalculator()" class="btn-back">â† ê²¬ì  ê³„ì‚°ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>

        <div class="order-summary-bar" id="order-summary-bar"></div>

        <div class="section-divider section-with-reset" style="border-top:none; padding-top:0; margin-top:0;">
            <div>
                <h2>ğŸ“ ì£¼ë¬¸ ì‹ ì²­</h2>
                <p class="section-desc">ì•„ë˜ ì •ë³´ë¥¼ ì…ë ¥í•˜ì—¬ ì£¼ë¬¸ì„ ì‹ ì²­í•˜ì„¸ìš”</p>
            </div>
            <button type="button" onclick="resetOrder()" class="btn-section-reset">ì´ˆê¸°í™”</button>
        </div>

        <form
            hx-post="/api/order/submit"
            hx-target="#order-result"
            hx-encoding="multipart/form-data"
            class="order-form"
        >
            <input type="hidden" id="order_width" name="width">
            <input type="hidden" id="order_height" name="height">
            <input type="hidden" id="order_quantity" name="quantity">
            <input type="hidden" id="order_ratio_file" name="ratio_file_path" value="">

            <div class="form-row">
                <div class="form-group">
                    <label for="customer_name">ì´ë¦„ *</label>
                    <input
                        type="text"
                        id="customer_name"
                        name="customer_name"
                        required
                        placeholder="í™ê¸¸ë™"
                    >
                </div>

                <div class="form-group">
                    <label for="customer_phone">ì—°ë½ì²˜ *</label>
                    <input
                        type="tel"
                        id="customer_phone"
                        name="customer_phone"
                        required
                        placeholder="010-1234-5678"
                    >
                </div>
            </div>

            <div class="form-group">
                <label for="customer_email">ì´ë©”ì¼ *</label>
                <input
                    type="email"
                    id="customer_email"
                    name="customer_email"
                    required
                    placeholder="example@email.com"
                >
            </div>

            <hr class="order-divider">

            <div class="form-group">
                <label for="design_file" id="design_file_label">ë””ìì¸ íŒŒì¼ (ì„ íƒ)</label>
                <div id="auto-attached-file" class="auto-attached" style="display:none;">
                    <span>ğŸ“ <strong id="auto-attached-name"></strong> (ë¹„ìœ¨ ê³„ì‚°ì—ì„œ ì²¨ë¶€ë¨)</span>
                    <button type="button" onclick="removeAutoAttached()" class="btn-remove-file">âœ• ì œê±°</button>
                </div>
                <input
                    type="file"
                    id="design_file"
                    name="file"
                    class="file-input"
                    accept="image/*,.ai,.psd,.pdf"
                >
                <small id="design_file_hint">AI, PSD, PNG, JPG, PDF ë“± ë””ìì¸ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</small>
            </div>

            <hr class="order-divider">

            <label class="option-checkbox">
                <input type="checkbox" id="opt_template_file" name="template_file" value="1" onchange="updateOrderTotal()">
                <span class="option-text">
                    <strong>ì‘ì—…í‹€ íŒŒì¼ ì œì‘ (AI/PSD)</strong>
                    <small>ì£¼ë¬¸ ì œì‘ìš© ì‘ì—…í‹€ íŒŒì¼ì´ í•„ìš”í•œ ê²½ìš°<br>(+10,000ì›, VATë³„ë„)</small>
                </span>
            </label>

            <div class="order-price-summary">
                <div class="order-price-row">
                    <span>ì œì‘ë¹„ (VATë³„ë„)</span>
                    <span id="order-base-price">0ì›</span>
                </div>
                <div class="order-price-row" id="order-template-row" style="display:none;">
                    <span>ì‘ì—…í‹€ ë¹„ìš© (VATë³„ë„)</span>
                    <span>10,000ì›</span>
                </div>
                <div class="order-price-row order-price-subtotal">
                    <span>í•©ê³„ (VATë³„ë„)</span>
                    <strong id="order-subtotal-price">0ì›</strong>
                </div>
                <div class="order-price-row order-price-total">
                    <span>ìµœì¢… ê¸ˆì•¡ (VATí¬í•¨)</span>
                    <strong id="order-final-price">0ì›</strong>
                </div>
            </div>

            <hr class="order-divider">

            <div class="form-group">
                <label for="notes">ìš”ì²­ì‚¬í•­ (ì„ íƒ)</label>
                <textarea
                    id="notes"
                    name="notes"
                    rows="3"
                    placeholder="ì¶”ê°€ë¡œ ìš”ì²­í•˜ì‹¤ ë‚´ìš©ì´ ìˆìœ¼ì‹œë©´ ì…ë ¥í•´ì£¼ì„¸ìš”"
                ></textarea>
            </div>

            <div id="order-error" class="order-error" style="display:none;"></div>
            <button type="submit" class="btn-order">ì£¼ë¬¸ ì‹ ì²­í•˜ê¸°</button>
        </form>

        <div id="order-result"></div>
    </div>
</div>


<script>
// ë¹„ìœ¨ ê³„ì‚° ì‚¬ìš© ì—¬ë¶€ ì¶”ì 
var ratioUsed = false;
// í˜•ìƒ ë¶„ì„ ëª¨ë“œ ì—¬ë¶€
window.shapeAnalysisAvailable = false;

// ì´ë¯¸ì§€ ì—…ë¡œë“œ í›„ í˜•ìƒ ëª¨ë“œ í™œì„±í™”
function enableCalculateButton() {
    var btn = document.getElementById('btn-calculate');
    var hint = document.getElementById('image-required-hint');
    var badge = document.getElementById('shape-mode-badge');
    var filePathInput = document.getElementById('shape_file_path');

    btn.disabled = false;
    hint.style.display = 'none';
    badge.style.display = 'flex';

    if (window.ratioFilePath) {
        filePathInput.value = window.ratioFilePath;
    }
}

// ê³„ì‚° ë²„íŠ¼ ë¹„í™œì„±í™” (ì´ë¯¸ì§€ ì´ˆê¸°í™” ì‹œ)
function disableCalculateButton() {
    var btn = document.getElementById('btn-calculate');
    var hint = document.getElementById('image-required-hint');
    var badge = document.getElementById('shape-mode-badge');
    var filePathInput = document.getElementById('shape_file_path');

    btn.disabled = true;
    hint.style.display = 'flex';
    badge.style.display = 'none';
    filePathInput.value = '';
    window.shapeAnalysisAvailable = false;
}

// ê³„ì‚° ê²°ê³¼ê°€ ë‚˜ì˜¤ë©´ ì£¼ë¬¸ ë°ì´í„° ì¤€ë¹„ (ì£¼ë¬¸í¼ì€ ì•„ì§ ì•ˆ ë³´ì—¬ì¤Œ)
document.body.addEventListener('htmx:afterSwap', function(event) {
    if (event.detail.target.id === 'result') {
        // ì£¼ë¬¸ í¼ ë°ì´í„°ë§Œ ì„¸íŒ… (í‘œì‹œëŠ” ë²„íŠ¼ í´ë¦­ ì‹œ)
        document.getElementById('order_width').value = document.getElementById('width').value;
        document.getElementById('order_height').value = document.getElementById('height').value;
        document.getElementById('order_quantity').value = document.getElementById('quantity').value;
        updateDesignFileRequired();
        updateOrderTotal();
    }
    if (event.detail.target.id === 'image-result') {
        ratioUsed = true;
        // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ â†’ ê³„ì‚° ë²„íŠ¼ í™œì„±í™”
        enableCalculateButton();
        // ë¹„ìœ¨ ê³„ì‚°ì—ì„œ ì—…ë¡œë“œí•œ íŒŒì¼ ê²½ë¡œë¥¼ ì£¼ë¬¸ í¼ì— ì„¸íŒ…
        if (window.ratioFilePath) {
            document.getElementById('order_ratio_file').value = window.ratioFilePath;
            // íŒŒì¼ëª… ì¶”ì¶œí•´ì„œ ìë™ ì²¨ë¶€ í‘œì‹œ
            var fileName = window.ratioFilePath.split('/').pop().replace('temp_', '');
            document.getElementById('auto-attached-name').textContent = fileName;
            document.getElementById('auto-attached-file').style.display = 'flex';
            document.getElementById('design_file').style.display = 'none';
            document.getElementById('design_file_hint').style.display = 'none';
        }
    }
});

// ë¹„ìœ¨ ê³„ì‚° ë²„íŠ¼ ë¡œë”© ìƒíƒœ
document.querySelector('.image-form').addEventListener('htmx:beforeRequest', function() {
    var btn = document.getElementById('btn-ratio');
    btn.disabled = true;
    btn.querySelector('.btn-ratio-text').style.display = 'none';
    btn.querySelector('.btn-ratio-loading').style.display = 'inline';
});
document.querySelector('.image-form').addEventListener('htmx:afterRequest', function() {
    var btn = document.getElementById('btn-ratio');
    btn.disabled = false;
    btn.querySelector('.btn-ratio-text').style.display = 'inline';
    btn.querySelector('.btn-ratio-loading').style.display = 'none';
});

// íŒŒì¼ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸° + ìë™ ëª¨ë“œë©´ ë°”ë¡œ ì œì¶œ
document.getElementById('image').addEventListener('change', function(e) {
    var file = e.target.files[0];
    var container = document.getElementById('image-preview-container');
    var preview = document.getElementById('image-preview');
    var nameSpan = document.getElementById('image-preview-name');

    if (file) {
        nameSpan.textContent = file.name;
        if (file.type.startsWith('image/')) {
            var url = URL.createObjectURL(file);
            preview.onload = function() { URL.revokeObjectURL(url); };
            preview.src = url;
            preview.style.display = 'block';
        } else {
            // .ai, .psd ë“± ë¯¸ë¦¬ë³´ê¸° ë¶ˆê°€
            preview.style.display = 'none';
        }
        container.style.display = 'flex';
    } else {
        container.style.display = 'none';
    }
    autoSubmitIfFileReady();
});

// ê¸°ì¤€ ë°©í–¥ ë¼ë²¨ ì—…ë°ì´íŠ¸
function updateTargetLabel() {
    var dim = document.getElementById('target_dimension').value;
    document.getElementById('target_size_label').textContent = dim === 'width' ? 'ì›í•˜ëŠ” ê°€ë¡œ (mm)' : 'ì›í•˜ëŠ” ì„¸ë¡œ (mm)';
}

// ìë™ í¬ê¸° í† ê¸€
function toggleAutoSize() {
    var checked = document.getElementById('auto-size').checked;
    var dimSelect = document.getElementById('target_dimension');
    var sizeGroup = document.getElementById('target_size_group');
    var sizeInput = document.getElementById('target_size');

    if (checked) {
        dimSelect.disabled = true;
        dimSelect.parentElement.style.opacity = '0.4';
        sizeGroup.style.display = 'none';
        sizeInput.removeAttribute('name');
        sizeInput.value = '';
        dimSelect.removeAttribute('name');
        // íŒŒì¼ì´ ì´ë¯¸ ì„ íƒë˜ì–´ ìˆìœ¼ë©´ ìë™ ì œì¶œ
        autoSubmitIfFileReady();
    } else {
        dimSelect.disabled = false;
        dimSelect.parentElement.style.opacity = '1';
        sizeGroup.style.display = 'block';
        sizeInput.setAttribute('name', 'target_size');
        dimSelect.setAttribute('name', 'target_dimension');
    }
}

// ìë™ ëª¨ë“œì—ì„œ íŒŒì¼ì´ ìˆìœ¼ë©´ ë°”ë¡œ ì œì¶œ
function autoSubmitIfFileReady() {
    var fileInput = document.getElementById('image');
    var autoChecked = document.getElementById('auto-size').checked;
    if (autoChecked && fileInput.files.length > 0) {
        document.querySelector('.image-form').dispatchEvent(new Event('submit', {bubbles: true, cancelable: true}));
        htmx.trigger(document.querySelector('.image-form'), 'submit');
    }
}

// ë””ìì¸ íŒŒì¼ í•„ìˆ˜/ì„ íƒ ì—…ë°ì´íŠ¸
function updateDesignFileRequired() {
    var label = document.getElementById('design_file_label');
    var input = document.getElementById('design_file');
    var hint = document.getElementById('design_file_hint');

    input.required = false;

    if (!ratioUsed) {
        label.textContent = 'ë””ìì¸ íŒŒì¼ *';
        hint.textContent = 'ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ ë””ìì¸ íŒŒì¼ì„ ì²¨ë¶€í•´ ì£¼ì„¸ìš”';
        window.fileRequired = true;
    } else {
        label.textContent = 'ë””ìì¸ íŒŒì¼ (ì„ íƒ)';
        hint.textContent = 'ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œ ì²¨ë¶€í•œ íŒŒì¼ì´ ìˆìœ¼ë¯€ë¡œ ì„ íƒì‚¬í•­ì…ë‹ˆë‹¤';
        window.fileRequired = false;
    }
}

// ìë™ ì²¨ë¶€ íŒŒì¼ ì œê±°
function removeAutoAttached() {
    document.getElementById('auto-attached-file').style.display = 'none';
    document.getElementById('design_file').style.display = '';
    document.getElementById('design_file_hint').style.display = '';
    document.getElementById('order_ratio_file').value = '';
    window.ratioFilePath = '';
    updateDesignFileRequired();
}

// ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì œê±°
function clearImagePreview() {
    var container = document.getElementById('image-preview-container');
    var preview = document.getElementById('image-preview');
    var fileInput = document.getElementById('image');
    container.style.display = 'none';
    preview.src = '';
    fileInput.value = '';
}

// ë¹„ìœ¨ ê³„ì‚° ì„¹ì…˜ ì´ˆê¸°í™”
function resetRatio() {
    var form = document.querySelector('#ratio-calc-section .image-form');
    if (form) form.reset();
    document.getElementById('auto-size').checked = false;
    document.getElementById('image-result').innerHTML = '';
    window.ratioFilePath = '';
    clearImagePreview();
    toggleAutoSize();
    ratioUsed = false;
    unlockSizeFields();
    disableCalculateButton();
}

// ê°€ë¡œ/ì„¸ë¡œ ì…ë ¥ ì ê¸ˆ í•´ì œ
function unlockSizeFields() {
    var w = document.getElementById('width');
    var h = document.getElementById('height');
    w.readOnly = false;
    h.readOnly = false;
    w.classList.remove('readonly-field');
    h.classList.remove('readonly-field');
    window.ratioLocked = false;
}

// ë‹¨ê°€ ê³„ì‚° ì„¹ì…˜ ì´ˆê¸°í™”
function resetCalc() {
    unlockSizeFields();
    document.querySelector('.calculator-form').reset();
    document.getElementById('result').innerHTML = '<p class="placeholder">ìœ„ ì •ë³´ë¥¼ ì…ë ¥í•˜ì‹œë©´ ìë™ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.</p>';
    document.getElementById('order-section').style.display = 'none';
    // ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´ ë²„íŠ¼ ë¹„í™œì„±í™” ìœ ì§€
    if (!window.ratioFilePath) {
        disableCalculateButton();
    }
}

// ì£¼ë¬¸ ê¸ˆì•¡ ì—…ë°ì´íŠ¸
function updateOrderTotal() {
    var base = window.calcPrice || 0;
    var templateChecked = document.getElementById('opt_template_file').checked;
    var templateRow = document.getElementById('order-template-row');
    var totalBeforeVat = base + (templateChecked ? 10000 : 0);
    var totalWithVat = Math.floor(totalBeforeVat * 1.1);

    document.getElementById('order-base-price').textContent = base.toLocaleString() + 'ì›';
    templateRow.style.display = templateChecked ? 'flex' : 'none';
    document.getElementById('order-subtotal-price').textContent = totalBeforeVat.toLocaleString() + 'ì›';
    document.getElementById('order-final-price').textContent = totalWithVat.toLocaleString() + 'ì›';
    // ìµœì¢… ê¸ˆì•¡ ì €ì¥ (ì£¼ë¬¸ ì™„ë£Œ í™”ë©´ì—ì„œ ì‚¬ìš©)
    window.orderFinalPrice = totalWithVat;
}

// ì£¼ë¬¸ ì‹ ì²­ í˜ì´ì§€ë¡œ ì „í™˜
function goToOrderForm() {
    var w = document.getElementById('width').value;
    var h = document.getElementById('height').value;
    var qty = document.getElementById('quantity').value;
    var basePrice = window.calcPrice || 0;

    // ìš”ì•½ ë°” ì—…ë°ì´íŠ¸
    var finalPrice = Math.floor(basePrice * 1.1);
    var summaryBar = document.getElementById('order-summary-bar');
    summaryBar.innerHTML = '<span><em>í¬ê¸°</em><strong>' + w + 'mm Ã— ' + h + 'mm</strong></span><span><em>ìˆ˜ëŸ‰</em><strong>' + qty + 'ê°œ</strong></span><span><em>ê²°ì œ ê¸ˆì•¡</em><strong>' + finalPrice.toLocaleString() + 'ì› (VATí¬í•¨)</strong></span>';

    // ê³„ì‚°ê¸° ì˜ì—­ ìˆ¨ê¸°ê¸°, ì£¼ë¬¸ í¼ ë³´ì´ê¸°
    document.getElementById('calc-area').style.display = 'none';
    document.getElementById('order-section').style.display = 'block';
    updateOrderTotal();
    window.scrollTo({top: 0, behavior: 'smooth'});
}

// ê³„ì‚°ê¸°ë¡œ ëŒì•„ê°€ê¸°
function backToCalculator() {
    document.getElementById('order-section').style.display = 'none';
    document.getElementById('calc-area').style.display = 'block';
    // ê²°ê³¼ ì˜ì—­ìœ¼ë¡œ ìŠ¤í¬ë¡¤
    var resultEl = document.getElementById('result');
    if (resultEl) resultEl.scrollIntoView({behavior: 'smooth'});
}

// ì£¼ë¬¸ ì‹ ì²­ ì„¹ì…˜ ì´ˆê¸°í™”
function resetOrder() {
    document.querySelector('.order-form').reset();
    document.getElementById('order-result').innerHTML = '';
    document.getElementById('order-error').style.display = 'none';
    updateDesignFileRequired();
    updateOrderTotal();
}

// ì£¼ë¬¸ í¼ ì»¤ìŠ¤í…€ ìœ íš¨ì„± ê²€ì‚¬
document.querySelector('.order-form').addEventListener('htmx:configRequest', function(event) {
    var errorDiv = document.getElementById('order-error');
    errorDiv.style.display = 'none';

    var errors = [];

    // í•„ìˆ˜ ì…ë ¥ ê²€ì¦
    var name = document.getElementById('customer_name').value.trim();
    var phone = document.getElementById('customer_phone').value.trim();
    var email = document.getElementById('customer_email').value.trim();

    if (!name) errors.push('ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
    if (!phone) errors.push('ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
    else if (phone.replace(/-/g, '').length < 10) errors.push('ì—°ë½ì²˜ë¥¼ ì •í™•íˆ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
    if (!email) errors.push('ì´ë©”ì¼ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');

    // ë””ìì¸ íŒŒì¼ ê²€ì¦ (ì´ë¯¸ì§€ ë¯¸ì—…ë¡œë“œ ì‹œ)
    var fileInput = document.getElementById('design_file');
    var ratioFile = document.getElementById('order_ratio_file').value;
    if (window.fileRequired && !fileInput.files.length && !ratioFile) {
        errors.push('ë””ìì¸ íŒŒì¼ì„ ì²¨ë¶€í•´ ì£¼ì„¸ìš”.');
    }

    if (errors.length > 0) {
        event.preventDefault();
        errorDiv.innerHTML = errors.join('<br>');
        errorDiv.style.display = 'block';
        errorDiv.scrollIntoView({behavior: 'smooth', block: 'center'});
        return;
    }
});

// HTMX ì—ëŸ¬ ì‘ë‹µ ì²˜ë¦¬
document.body.addEventListener('htmx:responseError', function(event) {
    if (event.detail.target && event.detail.target.id === 'order-result') {
        var errorDiv = document.getElementById('order-error');
        errorDiv.innerHTML = 'ì£¼ë¬¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
        errorDiv.style.display = 'block';
        errorDiv.scrollIntoView({behavior: 'smooth', block: 'center'});
    }
});

// ì œì¶œ ì¤‘ ë²„íŠ¼ ìƒíƒœ ë³€ê²½
document.querySelector('.order-form').addEventListener('htmx:beforeRequest', function() {
    var btn = document.querySelector('.btn-order');
    btn.disabled = true;
    btn.textContent = 'ì£¼ë¬¸ ì²˜ë¦¬ ì¤‘...';
});
document.querySelector('.order-form').addEventListener('htmx:afterRequest', function() {
    var btn = document.querySelector('.btn-order');
    btn.disabled = false;
    btn.textContent = 'ì£¼ë¬¸ ì‹ ì²­í•˜ê¸°';
});
</script>

<style>
.section-with-reset {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.btn-section-reset {
    padding: 6px 14px;
    background: #fff;
    color: #F4B900;
    border: 1.5px solid #F4B900;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
    flex-shrink: 0;
    margin-top: 4px;
}

.btn-section-reset:hover {
    background: #F4B900;
    color: #fff;
}

.section-divider {
    margin: 32px 0 16px 0;
    padding-top: 32px;
    border-top: 2px solid #f0f0f0;
}

.section-divider:first-of-type {
    border-top: none;
    padding-top: 0;
}

.section-divider h2 {
    font-size: 20px;
    color: #333;
    margin-bottom: 8px;
    font-weight: 700;
}

.section-desc {
    font-size: 14px;
    color: #666;
    margin-bottom: 16px;
}

.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
}

.flex-1 {
    flex: 1;
}

.flex-2 {
    flex: 2;
}

.image-form {
    margin-bottom: 16px;
}

.file-input {
    padding: 8px 12px !important;
    border: 2px dashed #e0e0e0 !important;
    background: #f8f9fa;
    cursor: pointer;
}

.file-input:hover {
    border-color: #F4B900 !important;
    background: #fffbf0;
}

.btn-secondary {
    width: 100%;
    padding: 12px;
    background: #fff;
    color: #F4B900;
    border: 2px solid #F4B900;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-secondary:hover {
    background: #F4B900;
    color: #fff;
}

.btn-secondary:disabled {
    opacity: 0.7;
    cursor: wait;
    background: #F4B900;
    color: #fff;
}

.btn-ratio-loading {
    animation: pulse 1.2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.order-section {
    animation: fadeIn 0.5s;
}

.order-form textarea {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 16px;
    font-family: inherit;
    resize: vertical;
}

.order-form small {
    display: block;
    margin-top: 6px;
    font-size: 13px;
    color: #666;
}

.order-error {
    background: #fff3f3;
    border: 1px solid #e74c3c;
    color: #c0392b;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 14px;
    line-height: 1.8;
    margin-bottom: 12px;
}

.btn-order {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, #F4B900 0%, #E5A800 100%);
    color: #1A1A1A;
    border: none;
    border-radius: 8px;
    font-size: 18px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    margin-top: 8px;
}

.btn-order:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
    box-shadow: none !important;
}

.btn-order:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(244, 185, 0, 0.6);
}

/* ì£¼ë¬¸ ì‹ ì²­í•˜ê¸° ë²„íŠ¼ (ê²°ê³¼ í•˜ë‹¨) */
.btn-go-order {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, #F4B900 0%, #E5A800 100%);
    color: #1A1A1A;
    border: none;
    border-radius: 8px;
    font-size: 18px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    margin-top: 16px;
}

.btn-go-order:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(244, 185, 0, 0.6);
}

/* ëŒì•„ê°€ê¸° ë²„íŠ¼ */
.btn-back {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 10px 16px;
    background: #fff;
    color: #666;
    border: 1.5px solid #ddd;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 16px;
}

.btn-back:hover {
    color: #F4B900;
    border-color: #F4B900;
}

/* ì£¼ë¬¸ ìš”ì•½ ë°” */
.order-summary-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 8px 16px;
    padding: 14px 20px;
    background: #fffbf0;
    border: 2px solid #F4B900;
    border-radius: 10px;
    margin-bottom: 20px;
    font-size: 14px;
    font-weight: 600;
    color: #333;
}

.order-summary-bar span {
    display: flex;
    align-items: center;
    gap: 8px;
    white-space: nowrap;
}

.order-summary-bar em {
    font-style: normal;
    color: #888;
    font-weight: 500;
    font-size: 13px;
}

.order-summary-bar strong {
    color: #333;
}

@media (max-width: 600px) {
    .section-with-reset {
        flex-wrap: wrap;
        gap: 8px;
    }
    .section-desc {
        margin-bottom: 4px;
    }
    .order-summary-bar {
        flex-direction: column;
        gap: 8px;
        padding: 14px 16px;
        font-size: 14px;
    }
    .order-summary-bar span {
        justify-content: space-between;
        width: 100%;
    }
    .btn-back {
        font-size: 13px;
        padding: 8px 12px;
        width: 100%;
        justify-content: center;
    }
}

/* í—¤ë” í•˜ë‹¨ êµ¬ë¶„ì„  */
.header-divider {
    border: none;
    border-top: 2px solid #F4B900;
    margin: 16px 0 8px 0;
}

/* ì£¼ë¬¸ í¼ ë‚´ êµ¬ë¶„ì„  */
.order-divider {
    border: none;
    border-top: 1px solid #e8e8e8;
    margin: 20px 0;
}

/* ì½ê¸° ì „ìš© í•„ë“œ (ë¹„ìœ¨/ìë™ ê³„ì‚° ì ìš© ì‹œ) */
.readonly-field {
    background: #f0f0f0 !important;
    color: #888 !important;
    border-color: #ccc !important;
    cursor: not-allowed;
}

/* ìë™ í¬ê¸° í† ê¸€ */
.auto-size-toggle-wrap {
    margin-bottom: 12px;
    padding: 14px 16px;
    background: #f5f5f5;
    border-radius: 10px;
    border: 1px solid #e0e0e0;
}

.auto-size-toggle {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    font-size: 15px;
    font-weight: 600;
    color: #333;
}

.auto-size-hint {
    display: block;
    margin-top: 8px;
    margin-left: 28px;
    font-size: 13px;
    color: #888;
}

.auto-size-toggle input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: #F4B900;
}

/* ìë™ ì²¨ë¶€ íŒŒì¼ í‘œì‹œ */
.auto-attached {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    background: #d4edda;
    border: 1px solid #c3e6cb;
    border-radius: 8px;
    font-size: 14px;
    color: #155724;
    margin-bottom: 8px;
}

.btn-remove-file {
    background: none;
    border: 1px solid #155724;
    color: #155724;
    border-radius: 4px;
    padding: 4px 10px;
    font-size: 12px;
    cursor: pointer;
    font-weight: 600;
}
.btn-remove-file:hover {
    background: #155724;
    color: white;
}

/* íŒŒì¼ í¬ë§· íŒíŠ¸ */
.file-format-hint {
    font-size: 13px;
    color: #666;
    background: #f9f9f9;
    border-left: 3px solid #F4B900;
    padding: 10px 12px;
    margin-bottom: 14px;
    border-radius: 0 6px 6px 0;
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.file-format-hint p {
    margin: 0;
    line-height: 1.5;
}

/* select ì…ë ¥ */
.select-input {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 16px;
    background: #fff;
    cursor: pointer;
    appearance: auto;
}

/* ì´ë¯¸ì§€ í•„ìˆ˜ ì•ˆë‚´ */
.image-required-hint {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px 16px;
    background: #fff3e0;
    border: 1.5px solid #ffb74d;
    border-radius: 8px;
    margin-bottom: 8px;
    font-size: 14px;
    font-weight: 600;
    color: #e65100;
}

/* ì‘ì—…í‹€ ì˜µì…˜ ì²´í¬ë°•ìŠ¤ */
.option-checkbox {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 14px;
    background: #fff;
    border: 1.5px solid #e0e0e0;
    border-radius: 8px;
    cursor: pointer;
    margin-bottom: 16px;
    transition: all 0.2s;
}

.option-checkbox:hover {
    border-color: #F4B900;
}

.option-checkbox:has(input:checked) {
    border-color: #F4B900;
    background: #fffbf0;
}

.option-checkbox input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: #F4B900;
    flex-shrink: 0;
}

.option-text {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.option-text strong {
    font-size: 14px;
    color: #333;
}

.option-text small {
    font-size: 12px;
    color: #888;
}

/* í˜•ìƒ ë¶„ì„ ëª¨ë“œ ë±ƒì§€ */
.shape-mode-badge {
    display: flex;
    flex-direction: column;
    gap: 4px;
    padding: 12px 16px;
    background: #f0f7ff;
    border: 1.5px solid #4a90d9;
    border-radius: 8px;
    margin-bottom: 12px;
}

.shape-mode-badge span {
    font-size: 14px;
    font-weight: 600;
    color: #2c5282;
}

.shape-mode-badge small {
    font-size: 12px;
    color: #4a6fa5;
}

/* ì£¼ë¬¸ ê¸ˆì•¡ ìš”ì•½ */
.order-price-summary {
    background: #f9f9f9;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    padding: 16px;
    margin-bottom: 16px;
}

.order-price-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    font-size: 14px;
    color: #666;
}

.order-price-subtotal {
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid #e0e0e0;
    font-size: 14px;
    color: #555;
}

.order-price-subtotal strong {
    font-size: 15px;
    color: #555;
}

.order-price-total {
    margin-top: 6px;
    padding-top: 8px;
    border-top: 2px solid #F4B900;
    font-size: 16px;
    color: #333;
}

.order-price-total strong {
    font-size: 22px;
    color: #F4B900;
}

/* ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° */
.image-preview-container {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 10px;
    padding: 10px;
    background: #f8f9fa;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
}

.image-preview-wrap {
    flex-shrink: 0;
    width: 80px;
    height: 80px;
    border-radius: 6px;
    overflow: hidden;
    background:
        linear-gradient(45deg, #e0e0e0 25%, transparent 25%),
        linear-gradient(-45deg, #e0e0e0 25%, transparent 25%),
        linear-gradient(45deg, transparent 75%, #e0e0e0 75%),
        linear-gradient(-45deg, transparent 75%, #e0e0e0 75%);
    background-size: 12px 12px;
    background-position: 0 0, 0 6px, 6px -6px, -6px 0;
    display: flex;
    align-items: center;
    justify-content: center;
}

.image-preview-wrap img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
}

.image-preview-info {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    min-width: 0;
}

.image-preview-name {
    font-size: 13px;
    color: #555;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.btn-preview-remove {
    flex-shrink: 0;
    width: 28px;
    height: 28px;
    border: 1px solid #ccc;
    background: #fff;
    border-radius: 50%;
    font-size: 14px;
    color: #888;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.btn-preview-remove:hover {
    background: #ff4444;
    border-color: #ff4444;
    color: #fff;
}

</style>
{% endblock %}
